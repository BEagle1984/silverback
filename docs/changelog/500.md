---
uid: releases-500
---

# Release Notes v5.x.x

## [5.0.0-beta.1](https://github.com/BEagle1984/silverback/releases/tag/v5.0.0-beta.1)

Silverback 5.0.0 is the most significant update in the library’s history, built on years of user feedback and real-world experience. This release is more than just an upgrade—it’s a **complete refactoring** that enhances flexibility, performance, and maintainability while laying a strong foundation for future innovations.

### ⚡ Hightlights

* An **improved configuration API** that makes it easier to set up Silverback exactly the way you want, with a more intuitive and consistent syntax. The new fluent API is designed to be more readable and straightforward and to giving you more control over the Kafka and MQTT clients that are used under the hood.
```csharp
services.AddSilverback()
    .WithConnectionToMessageBroker(options => options.AddKafka())
    .AddKafkaClients(clients => clients
        .WithBootstrapServers("PLAINTEXT://localhost:9092")
        .AddProducer(producer => producer
            .Produce<MyMessage>(endpoint => endpoint
                .ProduceTo("my-topic"))
            .Produce<MyMessage2>(endpoint => endpoint
                .ProduceTo("my-topic-2")))
        .AddConsumer(consumer => consumer
            .WithGroupId("consumer1")
            .AutoResetOffsetToEarliest()
            .Consume<MyMessage3>(endpoint => endpoint
                .ConsumeFrom("my-topic-3")
                .OnError(policy => policy.Retry(3).ThenSkip()))
            .Consume<MyMessage4>(endpoint => endpoint
                .ConsumeFrom("my-topic-4")
                .EnableBatchProcessing(100, TimeSpan.FromSeconds(5))
                .OnError(policy => policy.Skip()))));
```
* The new **WrapAndPublish** and **WrapAndPublishAsync** methods allow you to enrich the message envelope with headers, Kafka keys, and other metadata before publishing it.
```csharp
publisher.WrapAndPublish(
    new MyMessage { Content = "Hello, Silverback!" },
    envelope => envelope
        .AddHeader("custom-header", "custom-value")
        .WithKafkaKey("my-key"));
```
* **WrapAndPublishBatch** and **WrapAndPublishBatchAsync** methods extend the **WrapAndPublish** functionality to support streaming, mapping, and efficient batching with Kafka.
```csharp
await publisher.WrapAndPublishBatchAsync(
    entities,
    entity => new MyMessage { Id = entity.Id },
    envelope => envelope
        .AddHeader("custom-header", "custom-value")
        .WithKafkaKey("my-key"));
```
* The mediator (`IPublisher`) has been improved on many levels
  * is now registered as **transient** instead of scoped, allowing you to inject it into singleton services
  * **IEventPublisher**, **ICommandPublisher**, and **IQueryPublisher** have been replaced by extension methods on `IPublisher`, so you don't need multiple dependencies anymore
  * supports **CancellationToken**
  * supports **ValueTask** return types
  * more performance and reduced allocations
* Many new features to leverage the power of **Kafka** and **MQTT**
  * Kafka **transactions**
  * Confluent **schema registry** support
  * Kakfa consumer **cooperative sticky** partition assignment strategy
  * **MQTT 5 request-response**
* Redesigned and improved storage packages
  * native support for **PostgreSQL** and **SQLite** (more to come in the future), as well as **Entity Framework**
  * rethought and rewritten **outbox**
  * **client-side offset storage** for Kafka

In the following sections, you'll find more a more detailed and canonical list of improvements, new features, and breaking changes.

### What's New

* Clean up code and increase tests coverage
* Reduce allocations and improve performance in many places (see <xref:performance>)
* Register <xref:Silverback.Messaging.Publishing.IPublisher> as transient instead of scoped to allow injecting it into singleton services
* Add `CancellationToken` support to the mediator (see <xref:mediator>)
* Improve builders for error policies
* Support subscribers returning `ValueTask`
* Support exponential delay in `RetryErrorPolicy`
* Add new `AddHeader`, `WithMessageId` and `WithKafkaKey` overloads in `ProducerEndpointConfigurationBuilder` for easier and more readable configuration
* Introduce typed endpoints registration using `Consume<TMessage>` and `Produce<TMessage>` methods (replacing `AddInbound` and `AddOutbound`), making the nested configuration more readable and type-safe (see <xref:producing> and <xref:consuming>)
* Automatically set the typed deserializer according to the message type when using `Consume<TMessage>` to configure the endpoint (see <xref:deserialization>)
* Automatically set the typed <xref:Silverback.Messaging.BinaryMessages.BinaryMessageDeserializer`1> according to the message type when using `Consume<TMessage>` to configure the endpoint (see <xref:deserialization>)
* Add full fluent API for Kafka and MQTT configuration (see <xref:producing> and <xref:consuming>)
* Rewrite storage implementation from scratch and introduce new [Silverback.Storage.PostgreSql](https://www.nuget.org/packages/Silverback.Storage.PostgreSql/), [Silverback.Storage.Sqlite](https://www.nuget.org/packages/Silverback.Storage.Sqlite/), [Silverback.Storage.EntityFramework](https://www.nuget.org/packages/Silverback.Storage.EntityFramework/) and [Silverback.Storage.Memory](https://www.nuget.org/packages/Silverback.Storage.Memory/) packages (see <xref:storage>)
* Refactor transactional outbox adding support for transaction enlistment (even if not using Entity Framework) and improving performance (see <xref:outbox>)
* Improve outbox worker reliability
* Add message filtering in producer configuration (see <xref:producing>)
* Improve and simplify tombstone handling (see <xref:producing-tombstone> and <xref:consuming-tombstone>)
* Add `IInboundEnvelope` extensions to get broker specific metadata such as `GetKafkaOffset()`, `GetKafkaTimestamp()`, `GetMqttResponseTopic()` and `GetMqttCorrelationData()`
* Add `IOutboundEnvelope` extensions to set broker specific metadata such as `SetKafkaKey()`, `SetMqttResponseTopic()` and `SetMqttCorrelationData()`
* Add `WrapAndProduce` and `WrapAndProduceAsync` methods to <xref:Silverback.Messaging.Publishing.IPublisher> to allow envelope enrichment (setting headers, kafka key, etc.) and dynamic routing (see <xref:producing>)
* Add `WrapAndProduceBatch` and `WrapAndProduceBatchAsync` methods to <xref:Silverback.Messaging.Publishing.IPublisher> with the same capabilities of `WrapAndProduce` and `WrapAndProduceAsync`, supporting streaming, mapping and efficient batching with Kafka (see <xref:producing>)
* Refactor and improve <xref:Silverback.Domain.EntityFrameworkDomainEventsPublisher`1>
* Improve `ITestingHelper` to allow waiting for specific topics to be consumed (see <xref:testing>)
* Add <xref:Silverback.Messaging.Messages.InboundEnvelopeBuilder`1> and <xref:Silverback.Messaging.Messages.OutboundEnvelopeBuilder`1> to testing packages to help creating test envelopes (see <xref:testing>)
* Support Kafka cooperative sticky partition assignment strategy
* Implement transactional client-side offset storage (see <xref:kafka-offset>)
* Support Kafka transactions (see <xref:kafka-transactions>)
* Add support for Confluent schema registry (Avro, Json and Protobuf), including mock for in-memory testing
* Add `IgnoreNoMatchingSubscribersError` setting to MQTT producer endpoints, to prevent throwing when no subscriber is consuming the produced message
* Basic support for MQTT 5 request-response
* Add <xref:Silverback.Messaging.Subscribers.ConsumerNameFilterAttribute> to filter the subscribers by consumer name (replaces <xref:Silverback.Messaging.Subscribers.KafkaGroupIdFilterAttribute> and <xref:Silverback.Messaging.Subscribers.MqttClientIdFilterAttribute>)
* Add new built-in (de-)serializers to support raw `string`, `Stream` and `byte[]` (see <xref:serialization> and <xref:deserialization>)
* Improve [Activity](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.activity) handling for sequences (batch processing, chunking, etc.)
* Upgrade to [Confluent.Kafka 2.8.0](https://github.com/confluentinc/confluent-kafka-dotnet/releases/tag/v2.2.0)
* Upgrade to [MQTTnet 5.0.1.1416](https://github.com/chkr1011/MQTTnet/releases/tag/v5.0.1.1416)

### Breaking Changes

This release includes many breaking changes, as the library underwent a significant refactoring. The following list might be incomplete but should give you an overview of the most important changes:

* `IEventPublisher`, `ICommandPublisher` and `IQueryPublisher` replaced by extension methods on <xref:Silverback.Messaging.Publishing.IPublisher>
* Refactored the configuration model and related fluent API, refer to the updated [Guides](xref:setup) and [Samples](xref:samples) to see how it looks like in the new version
  * Many types, properties and methods have been renamed or modified to improve readability, consistency, and ergonomics
  * Reorganized the configuration namespaces, some extension methods might have been moved to a different namespace, thus requiring a different `using`.
  * Changed the endpoint models and most of the configuration models to [records](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/record) with init-only properties
  * Building the endpoints directly is still supported but the strongly recommended preferred way is to use the fluent API, therefore from now on the documentation will only show that approach
  * Removed all builders interfaces and exposed the actual classes directly (e.g. `ISilverbackBuilder` to `SilverbackBuilder`)
  * `AddOutbound`/`AddInbound` methods have been replaced by `AddKafkaClients`/`AddMqttClients` and `Produce`/`Consume` methods
  * `BatchSettings`, `ChunkSettings`, `SequenceSettings`, ` EncryptionSettings`, etc. renamed to `BatchConfiguration`, `ChunkConfiguration`, `SequenceConfiguration`, ` EncryptionConfiguration`, etc.
  * `Configure` method for Kafka clients replaced by configuration methods such as `WithBootstrapServers`, `WithGroupId`, `WithClientId`, etc.
  * `IBrokerCallback` and `Add*BrokerCallbackHandler` methods renamed to `IBrokerClientCallback` and `Add*BrokerClientCallback`
  * ... (many more changes)
* Split the `IMessageSerializer` interface into <xref:Silverback.Messaging.Serialization.IMessageSerializer> and <xref:Silverback.Messaging.Serialization.IMessageDeserializer>
* Outbox and all storage dependent features have been rewritten from scratch, look at the [Guides](xref:setup) for more details about the new implementation
* Exactly once guard has been replaced by the client side offset storage (see <xref:kafka-offset>)
Publishing.IPublisher> itself and removed the `UseModel` configuration method (see <xref:mediator>)
* Removed the whole `IBroker` and `IBrokerCollection` constructs
  * They are superseded by the `IProducerCollection` and `IConsumerCollection` interfaces, as well as the `IBrokerClientCollection` which grants access to all underlying broker clients
* Changed some details in <xref:Silverback.Messaging.Broker.IProducer>/<xref:Silverback.Messaging.Broker.IConsumer> and their implementations
* A lot of methods have been changed to return a `ValueTask` instead of a `Task`
* Kafka key won't be set to a random `Guid` anymore but will be `null` if not explicitly set
* Some changes to default settings:
  * Increased default [KafkaConsumerConfiguration.MaxDegreeOfParallelism](xref:Silverback.Messaging.Configuration.Kafka.KafkaConsumerConfiguration#Silverback_Messaging_Configuration_Kafka_KafkaConsumerConfiguration_MaxDegreeOfParallelism) to 100
  * Increased default [KafkaConsumerConfiguration.BackpressureLimit](xref:Silverback.Messaging.Configuration.Kafka.KafkaConsumerConfiguration#Silverback_Messaging_Configuration_Kafka_KafkaConsumerConfiguration_BackpressureLimit) to 50
  * Changed default <xref:Silverback.Messaging.Serialization.NewtonsoftJsonMessageDeserializer`1> typename handling to `TypeNameHandling.None` to lay on the safe side
* Several changes have been made to <xref:Silverback.Testing.ITestingHelper>, <xref:Silverback.Testing.IKafkaTestingHelper>, and <xref:Silverback.Testing.IMqttTestingHelper>
* Removed the `AddSubscribers` methods allowing to register subscribers via a base type or interface
* ... (many more changes)

### Migration Guide

The migration from Silverback 4.x.x to 5.x.x is a significant step and requires some effort. The following list should give you an overview of the most important steps:
* _...coming soon..._

### Deprecation Notice

The support for RabbitMQ has been dropped in this release and the [Silverback.Integration.RabbitMQ](https://www.nuget.org/packages/Silverback.Integration.RabbitMQ) package has been deprecated. See [Deprecation notice: packages to be deprecated in Silverback v5](https://github.com/BEagle1984/silverback/discussions/237).
