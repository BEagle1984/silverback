---
uid: releases-300
---

# Release Notes v3.x.x

## [3.8.0](https://github.com/BEagle1984/silverback/releases/tag/v3.8.0)

### What's New

* Topic name resolvers can be used to filter the messages to be produce: returning `null` will discard the message

### Fixes

* Fix error policies not being triggered consistently when batch consuming
* Make `IntegrationSpy` fully thread-safe
* Prevent errors when the [IKafkaPartitionsRevokedCallback](xref:Silverback.Messaging.Broker.Callbacks.IKafkaPartitionsRevokedCallback) is invoked during application shutdown
* Improve error handling during connection to MQTT

## [3.7.3](https://github.com/BEagle1984/silverback/releases/tag/v3.7.3)

### Fixes

* Support topic names with symbols (e.g. hyphens) in mocked MQTT broker

## [3.7.2](https://github.com/BEagle1984/silverback/releases/tag/v3.7.2)

### Fixes

* Correctly invoke the [IKafkaOffsetCommittedCallback](xref:Silverback.Messaging.Broker.Callbacks.IKafkaOffsetCommittedCallback) when auto commit is disabled [[#167](https://github.com/BEagle1984/silverback/issues/167)]

## [3.7.1](https://github.com/BEagle1984/silverback/releases/tag/v3.7.1)

### Fixes

* Improve message streams abort process to avoid first chance exceptions (e.g. during dispose)

## [3.7.0](https://github.com/BEagle1984/silverback/releases/tag/v3.7.0)

### What's New

* Implement basic support for Kafka transactions via <xref:Silverback.Messaging.Broker.KafkaTransactionalProducer> _(Note: this is just a first step and a more comprehensive implementation is planned for the upcoming release 4.0.0)_
* Skip chunking when processing single chunk messages

### Fixes

* Fix possible race condition in consumer pipeline

## [3.6.1](https://github.com/BEagle1984/silverback/releases/tag/v3.6.1)

### Fixes

* Handle race condition in [BatchSequence](xref:Silverback.Messaging.Sequences.Batch.BatchSequence) with timeout
* Limit consumer status history

## [3.6.0](https://github.com/BEagle1984/silverback/releases/tag/v3.6.0)

### What's New

* Handle `IAsyncEnumerable<T>` returned by the subscriber and republished the contained messages
* Enrich Kafka messages moved by the <xref:Silverback.Messaging.Consuming.ErrorHandling.MoveMessageErrorPolicy> adding some extra headers containing some information about the source topic, partition, offset, etc. (see <xref:default-headers>)
* Allow filters such as the <xref:Silverback.Messaging.Subscribers.KafkaGroupIdFilterAttribute> or <xref:Silverback.Messaging.Subscribers.MqttClientIdFilterAttribute> to be added to the subscribers at runtime via the configuration API
* Add overload for `Publish` method in the error policies that forwards the exception as well as the envelope
* Throw `TimeoutException` from <xref:Silverback.Testing.KafkaTestingHelper> and <xref:Silverback.Testing.MqttTestingHelper>
* Improve MQTT connection related logs (info for successful reconnect and add broker name to log messages)
* Support shared sessions in mocked MQTT broker

### Fixes

* Ensure each consumed message gets a unique traceId (when the traceparent header is not present)
* Fix memory leak in consumer
* Fully validate messages, including nested objects

## [3.5.0](https://github.com/BEagle1984/silverback/releases/tag/v3.5.0)

### What's New

* Log `MqttClient` internal events (see <xref:logging>)
* Upgrade to [Confluent.Kafka 1.8.2](https://github.com/confluentinc/confluent-kafka-dotnet/releases/tag/v1.8.2)
* Upgrade to [MQTTnet 3.0.16](https://github.com/chkr1011/MQTTnet/releases/tag/v3.0.16)
* Upgrade to [RabbitMQ.Client 6.2.2](https://github.com/rabbitmq/rabbitmq-dotnet-client/releases/tag/v6.2.2)
* Update several dependencies

### Fixes

* Fix <xref:Silverback.Messaging.Broker.MqttConsumer> reconnection issues
* Handle edge cases related to MQTT acknowledgment timeout in <xref:Silverback.Messaging.Broker.MqttConsumer>
* Allow max retries specification and error policies chains with MQTT V3

## [3.4.0](https://github.com/BEagle1984/silverback/releases/tag/v3.4.0)

### What's New

* Support encryption key rotation (see <xref:encryption>)

## [3.3.1](https://github.com/BEagle1984/silverback/releases/tag/v3.3.1)

### Fixes

* Fix `AddHeaders<TMessage>` and `WithKafkaKey<TMessage>` not being correctly invoked by all `IProducer.Produce` and `IProducer.ProducerAsync` overloads
* Add endpoint friendly name to all logs

## [3.3.0](https://github.com/BEagle1984/silverback/releases/tag/v3.3.0)

### What's New

* Optimize in-memory mocked Kafka (avoid spawning too many threads)
* Support multiple brokers (with overlapping topic names) in mocked Kafka and MQTT
* Add message validation for both producer and consumer (see <xref:producing-validation> and <xref:consuming-validation>)
* Add new `AddInbound` overloads specifying message type for a more compact configuration when using the typed deserializer (see <xref:serialization>)

### Fixes

* Invoke the Kafka partition EOF callback for all connected consumers
* Ignore null or empty Kafka key in producer

## [3.2.0](https://github.com/BEagle1984/silverback/releases/tag/v3.2.0)

### What's New

* Add new Kafka partition EOF callback to be notified when the end of a partition is reached by the consumer (see <xref:broker-callbacks> and <xref:Silverback.Messaging.Broker.Callbacks.IKafkaPartitionEofCallback>)
* Allow multiple calls to `IKafkaConsumerEndpointBuilder.Configure` or `IKafkaProducerEndpointBuilder.Configure` for the same endpoint
* Observe a grace period in the <xref:Silverback.Messaging.HealthChecks.ConsumersHealthCheck> to prevent false positives during a normal Kafka rebalance
* Add optional friendly name to the endpoints (see `IEndpointBuilder<TBuilder>.WithName` and `Endpoint.FriendlyName`)
* Allow filtering the endpoints targeted by the <xref:Silverback.Messaging.HealthChecks.ConsumersHealthCheck> (see [AddConsumersCheck](xref:Microsoft.Extensions.DependencyInjection.HealthCheckBuilderExtensions))

## [3.1.1](https://github.com/BEagle1984/silverback/releases/tag/v3.1.1)

### Fixes

* Invoke broker callbacks during the application shutdown to allow custom code to be run when disconnecting

## [3.1.0](https://github.com/BEagle1984/silverback/releases/tag/v3.1.0)

### What's New

* Add new ways to configure headers and kafka key (see <xref:producing-headers>, <xref:consuming-headers>, and <xref:kafka-partitioning>)
* New callbacks for Kafka log events (see <xref:broker-callbacks>)
* Improve consumer status tracking introducing [ConsumerStatus.Ready](xref:Silverback.Messaging.Broker.ConsumerStatus)
    * Revert the Kafka consumer status from `Ready` to `Connected` whenever partitions are revoked or a poll timeout occurs
    * Adapt consumer health check to monitor the new status and report unhealthy if not `Ready` (see <xref:consumer-health-check>)
* Try to automatically recover from Kafka maximum poll interval exceed errors
* Improve Kafka static partition assignment with resolver function and fetching the available partitions (see <xref:kafka-partitioning>)
* Upgrade to [Confluent.Kafka 1.7.0](https://github.com/confluentinc/confluent-kafka-dotnet/releases/tag/v1.7.0)
* Upgrade to [MQTTnet 3.0.15](https://github.com/chkr1011/MQTTnet/releases/tag/v3.0.15)

### Fixes

* Prevent possible race condition causing messages to be skipped when a `RetryPolicy` kicks in for messages from multiple Kafka partitions simultaneously
* Prevent `ObjectDisposedException` to be thrown when Kafka events (e.g. statistics) are fired during the application shutdown
* Prevent `ObjectDisposedException` to be thrown when `Consumer.Dispose` is called multiple times
* Properly clear the trace context (`Activity`) when reconnecting the consumer to prevent the newly started consume loop to be tracked under the current message traceId
* Fix wrong prefix in MQTT log event names

## [3.0.1](https://github.com/BEagle1984/silverback/releases/tag/v3.0.1)

### Fixes

* Fix `IOutboxWriter` lifecycle [[#128](https://github.com/BEagle1984/silverback/issues/128)]

## [3.0.0](https://github.com/BEagle1984/silverback/releases/tag/v3.0.0)

### What's New

* Add support for MQTT (see <xref:broker>, <xref:producing>, <xref:consuming>, ...)
* Simplify configuration and reduce boilerplate
    * Simplify subscribers registration and get rid of the `ISubscriber` interface (see <xref:mediator>)
    * Scan subscribers automatically at startup to reduce cost of first message
    * Connect brokers and handle graceful shutdown automatically (see <xref:broker>)
    * Improve endpoints configuration API (see <xref:broker>)
    * Add `IServiceCollection.ConfigureSilverback` extension method to conveniently split the configuration code (see <xref:broker>)
* Refactor Silverback.Integration to support streaming
    * Create <xref:Silverback.Messaging.Messages.IMessageStreamEnumerable`1>
    * Improve chunking support in conjunction with streaming, requiring only one chunk at a time to be loaded into memory
    * Redesign sequences handling to support chunking, batch consuming and future sequences as well
* Improve Kafka partitions handling (see <xref:kafka-partitioning>)
    * Process partitions independently and concurrently
    * Add setting to produce to a specific partition
    * Add setting to manually assign the consumer partitions
* Add option to throw an exception if no subscriber is handling a message that was published to the internal bus or was consumed from a message broker (see `throwIfUnhandled` argument in the <xref:Silverback.Messaging.Publishing.IPublisher> methods and `ThrowIfUnhandled` property in the `IConsumerEndpoint`)
* Handle null messages as <xref:Silverback.Messaging.Messages.Tombstone>/<xref:Silverback.Messaging.Messages.Tombstone`1> (see <xref:consuming-tombstone>)
* Replace [Newtonsoft.Json](https://www.nuget.org/packages/Newtonsoft.Json) with [System.Text.Json](https://www.nuget.org/packages/System.Text.Json) to improve serialization and deserialization performance (the old serializers have been moved into the [Silverback.Integration.Newtonsoft](https://www.nuget.org/packages/Silverback.Integration.Newtonsoft) package, see <xref:serialization>)
* Improve outbound routing customization options with endpoint name resolvers (see <xref:producing>)
* Add non-blocking `Produce`/`ProduceAsync`/`RawProduce`/`RawProduceAsync` overloads to <xref:Silverback.Messaging.Broker.IProducer>, better suitable for higher throughput scenarios
* Refactor broker event handlers (see <xref:broker-callbacks>)
* Expose [IConsumer.StopAsync](xref:Silverback.Messaging.Broker.IConsumer#Silverback_Messaging_Broker_IConsumer_StopAsync_System_Boolean_) and [IConsumer.StartAsync](xref:Silverback.Messaging.Broker.IConsumer#Silverback_Messaging_Broker_IConsumer_StartAsync) methods to pause and resume consumers
* Add log levels configuration (see <xref:logging>)
* Improve (distributed) tracing (see <xref:logging>)
* Allow header names customization (see <xref:default-headers>)
* Add consumer status information and statistics (see <xref:broker>)
* Add basic consumer health check (see <xref:consumer-health-check>)
* Allow broker behaviors to be registered as transient, meaning that an instance will be created per each producer or consumer (see <xref:producer-behaviors> and <xref:consumer-behaviors>)
* Improve code quality
    * Enhance CI pipeline to use Roslyn analyzers
    * Integrate [SonarCloud](https://sonarcloud.io/dashboard?id=silverback))
    * Improve integration tests
    * Increase automated tests coverage
    * Enable nullable reference types and adjust all API
    * Document the entire public API
* Released some utilities to help writing automated tests involving Silverback.Integration (see <xref:testing>)
* Upgrade to [Confluent.Kafka 1.6.2](https://github.com/confluentinc/confluent-kafka-dotnet/releases/tag/v1.6.2)
* Upgrade to [RabbitMQ.Client 6.2.1](https://github.com/rabbitmq/rabbitmq-dotnet-client/releases/tag/v6.2.1)

### Fixes

* Fix `OutboxWorker` not publishing custom headers [[#102](https://github.com/BEagle1984/silverback/issues/102)]

### Breaking Changes

* Refactored <xref:Silverback.Messaging.Publishing.IPublisher>
    * Removed the overloads to publish a batch of messages (see <xref:mediator>)
    * Cannot subscribe to collection of messages anymore (see <xref:mediator>), unless they are consumed from a message broker (see <xref:consuming>)
* The chunks belonging to the same message must be contiguous (interleaved messages are at the moment not supported anymore) and in the same partition in case of Kafka
* Removed `ISubscriber` interface
* Removed `BusConfigurator` (moved all the configuration into the `ISilverbackBuilder` extension methods)
    * Replaced `BusConfigurator.Connect` with `ISilverbackBuilder.AddEndpointsConfigurator` and `ISilverbackBuilder.AddEndpoints` (or `ISilverbackBuilder.AddKafkaEndpoints` etc.) to configure the endpoints, while the broker is connected automatically at startup (see <xref:broker>)
    * Replaced `BusConfigurator.Subscribe` methods with `ISilverbackBuilder.AddDelegateSubscriber` (see <xref:mediator>)
    * Replaced `BusConfigurator.HandleMessagesOfType` methods with `ISilverbackBuilder.HandleMessageOfType` (see <xref:mediator>)
    * `BusConfigurator.ScanSubscribers` is not needed anymore since it gets called automatically at startup (from an [IHostedService](https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.hosting.ihostedservice))
* Removed `IServiceCollection.Add*Subscriber`, `IServiceCollection.Add*Behavior`, `IServiceCollection.Add*BrokerBehavior`, `IServiceCollection.AddEndpointsConfigurator`, `IServiceCollection.Add*OutboundRouter` extension methods, use the same methods on the `ISilverbackBuilder` (using `IServiceCollection.ConfigureSilverback` to get an instance if the `ISilverbackBuilder` if necessary, as shown in  <xref:setup>)
* Removed `IBrokerOptionsBuilder.Add*BrokerBehavior`, `IBrokerOptionsBuilder.RegisterConfigurator`, `IBrokerOptionsBuilder.Add*OutboundRouter` extension methods, use the same methods on the `ISilverbackBuilder` (using `IServiceCollection.ConfigureSilverback` to get an instance if the `ISilverbackBuilder` if necessary, as shown in  <xref:setup>)
* Reorganized the `Silverback.Messaging.Configuration` namespace moving some broker specific types under `Silverback.Messaging.Configuration.Kafka`, `Silverback.Messaging.Configuration.Rabbit` or `Silverback.Messaging.Configuration.Mqtt`
* The visibility of some types has been changed to internal to favor a cleaner and clearer API where the public types are well documented and their backward compatibility is valued
* Removed _Silverback_ prefix from exceptions name
* Removed the `IRequest<TResponse>` interface (it was implemented by both <xref:Silverback.Messaging.Messages.IQuery`1> and <xref:Silverback.Messaging.Messages.ICommand`1>)
* Changed _Impl_ methods suffix with _Core_, this affects some virtual members in the `Broker` and other base classes
* `IConsumer.Received` event replaced by a callback delegate
* `IBroker.GetConsumer` and `IBrokerCollection.GetConsumer` methods renamed to `IBroker.AddConsumer` and `IBrokerCollection.AddConsumer`
* `IQueueProducer` and `IQueueConsumer` renamed to `IOutboxWriter` and `IOutboxReader`
* The messages with a null body are by default mapped to a <xref:Silverback.Messaging.Messages.Tombstone>/<xref:Silverback.Messaging.Messages.Tombstone`1> (see <xref:consuming-tombstone>)
* Database:
    * Moved all entities (used with Entity Framework Core) to the `Silverback.Database.Model` namespace
    * Replaced `InboundMessage` entity with `InboundLogEntry`
    * Replaced `OutboundMessage` entity with `OutboxMessage`
    * Removed `TemporaryMessageChunk`
    * Modified schema of `StoredOffset` entity
* Moved and renamed some internally used types (e.g. `QueuedMessage`, `DbQueuedMessage`, ...)
* Complete redesign of the error policies
* Removed `IMessageIdProvider` and all related logic: the `Id` or `MessageId` property will not be automatically initialized anymore and its value will not be used as identifier for the outbound message anymore
* `WithConnectionTo<>`, `WithConnectionToKafka`, `WithConnectionToRabbitMQ` and `WithInMemoryBroker` have been removed, please use the new `WithConnectionToMessageBroker` and `AddKafka`/`AddRabbit` methods (see <xref:broker>)
* Replaced the internal messages for the Kafka events such as partitions revoked/assigned, offset commit, error, log and statistics with event handler interfaces (see <xref:broker-callbacks>)
* Deprecated [Silverback.Integration.InMemory](https://www.nuget.org/packages/Silverback.Integration.InMemory), use [Silverback.Integration.Kafka.Testing](https://www.nuget.org/packages/Silverback.Integration.Kafka.Testing), [Silverback.Integration.RabbitMQ.Testing](https://www.nuget.org/packages/Silverback.Integration.RabbitMQ.Testing), etc. instead
* Renamed `PartitioningKeyMemberAttribute` to <xref:Silverback.Messaging.Messages.KafkaKeyMemberAttribute>
* [Silverback.Integration.Configuration](https://www.nuget.org/packages/Silverback.Integration.Configuration) has been discontinued
* Renamed `Settings` property to `Options` in the default <xref:Silverback.Messaging.Serialization.JsonMessageSerializer> (since the switch to [System.Text.Json](https://www.nuget.org/packages/System.Text.Json))
* Removed `LogWithLevel` method from <xref:Silverback.Messaging.Consuming.ErrorHandling.SkipMessageErrorPolicy>, use the new `WithLogLevels` configuration instead
* Removed `Parallel` option from <xref:Silverback.Messaging.Subscribers.SubscribeAttribute>
* Renamed `Offset` to a more generic `BrokerMessageIdentifier` in the [Silverback.Integration](https://www.nuget.org/packages/Silverback.Integration) abstractions (including the envelopes)
* Some changes to the behaviors:
    * Renamed `Handle` to `HandleAsync` in the <xref:Silverback.Messaging.Publishing.IBehavior>, <xref:Silverback.Messaging.Broker.Behaviors.IProducerBehavior> and <xref:Silverback.Messaging.Broker.Behaviors.IConsumerBehavior>
    * Changed signature of the `HandleAsync` method (see <xref:mediator>, <xref:producer-behaviors> and <xref:consumer-behaviors>)
    * Changed some sort indexes and introduced some new broker behaviors, you may need to adjust the sort index of your custom behaviors (see <xref:producer-behaviors> and <xref:consumer-behaviors> for the updated list of built-in behaviors)
* Replaced `IBroker.Connect` and `IBroker.Disconnect` with `IBroker.ConnectAsync` and `IBroker.DisconnectAsync`
* Some major changes to batch consuming:
    * Removed all batch events (`BatchStartedEvent`, `BatchCompleteEvent`, `BatchProcessedEvent`, `BatchAbortedEvent`), refer to <xref:consuming> to learn how to leverage the new <xref:Silverback.Messaging.Messages.IMessageStreamEnumerable`1>
    * Setting the batch size to 1 doesn't disable batching anymore, set the `Batch` to `null` in the <xref:Silverback.Messaging.ConsumerEndpoint> to disable it
    * When batching is enabled the messages can be subscribed only via the <xref:Silverback.Messaging.Messages.IMessageStreamEnumerable`1> (see <xref:consuming>), the subscribers to the single messages will not be invoked
* <xref:Silverback.Messaging.Sequences.Chunking.ChunkSettings> moved from `Silverback.Messaging.LargeMessages` namespace to `Silverback.Messaging.Sequences.Chunking`
* Replaced `CoreEventIds`, `IntegrationEventIds`, `KafkaEventIds` and `RabbitEventIds` with <xref:Silverback.Diagnostics.CoreLogEvents>, <xref:Silverback.Diagnostics.IntegrationLogEvents>, <xref:Silverback.Diagnostics.KafkaLogEvents> and `RabbitLogEvents` (see also <xref:logging>)
* Deprecated support for Entity Framework 2, only the version 3.0.1 of [Silverback.Core.EntityFrameworkCore](https://www.nuget.org/packages/Silverback.Core.EntityFrameworkCore) will work with Silverback 3.0.0
* Modified message encryption for chunked messages and it will not be compatible with previous versions of Silverback (affects chunking+encryption only)
