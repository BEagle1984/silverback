<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Outbound Endpoint | Silverback </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Outbound Endpoint | Silverback ">
    <meta name="generator" content="docfx 2.56.6.0">
    
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../images/icons/favicon-16x16.png">
    <link rel="manifest" href="../../images/icons/site.webmanifest">
    <link rel="mask-icon" href="../../images/icons/safari-pinned-tab.svg" color="#5bbad5">
  
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
    <script src="https://kit.fontawesome.com/e3306be642.js" crossorigin="anonymous"></script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="outbound">
<h1 id="outbound-endpoint">Outbound Endpoint</h1>

<p>An outbound endpoint is used to configure silverback to automatically relay the integration messages that ate published to the internal bus to the message broker. Multiple outbound endpoints can be configured and Silverback will route the messages according to their type or a custom routing logic.</p>
<p>The endpoint object identifies the topic/queue that is being connected and the client configuration, such the connection options. The endpoint object is therefore very specific and every broker type will define it's own implementation of <a class="xref" href="../../api/Silverback.Messaging.IProducerEndpoint.html">IProducerEndpoint</a>.</p>
<p>The options in the endpoint object are also used to tweak the Silverback behavior (e.g. the <a class="xref" href="serialization.html">serialization</a>) and to enable additional features such as <a class="xref" href="chunking.html">chunking</a>, <a class="xref" href="encryption.html">encryption</a>, etc.</p>
<h2 id="apache-kafka">Apache Kafka</h2>
<p>The <a class="xref" href="../../api/Silverback.Messaging.KafkaProducerEndpoint.html">KafkaProducerEndpoint</a> is defined by
<a href="https://www.nuget.org/packages/Silverback.Integration.Kafka">Silverback.Integration.Kafka</a> and is used to declare an outbound endpoint connected to Apache Kafka.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_kafka-producer-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q_kafka-producer-fluent" data-tab="kafka-producer-fluent" tabindex="0" aria-selected="true">Fluent (preferred)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_kafka-producer-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q_kafka-producer-legacy" data-tab="kafka-producer-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_kafka-producer-fluent" role="tabpanel" data-tab="kafka-producer-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddOutbound&lt;IIntegrationEvent&gt;(endpoint =&gt; endpoint
                    .ProduceTo(&quot;order-events&quot;)
                    .EnableChunking(500000)
                    .ProduceToOutbox()));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q_kafka-producer-legacy" role="tabpanel" data-tab="kafka-producer-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new KafkaProducerEndpoint(&quot;order-events&quot;)
                {
                    Configuration = new KafkaProducerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;
                    },
                    Chunk = new ChunkSettings
                    {
                        Size = 500000
                    },
                    Strategy = new OutboxProduceStrategy()
                });
}
</code></pre>
</section>
</div>

<div class="NOTE">
<h5>Note</h5>
<p>For a more in-depth documentation about the Kafka client configuration refer also to the <a href="https://docs.confluent.io/current/clients/confluent-kafka-dotnet/api/Confluent.Kafka.html">confluent-kafka-dotnet documentation</a>.</p>
</div>
<h2 id="mqtt">MQTT</h2>
<p>The <a class="xref" href="../../api/Silverback.Messaging.MqttProducerEndpoint.html">MqttProducerEndpoint</a> is defined by
<a href="https://www.nuget.org/packages/Silverback.Integration.MQTT">Silverback.Integration.MQTT</a> and is used to declare an outbound endpoint connected to an MQTT broker.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_mqtt-producer-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_mqtt-producer-fluent" data-tab="mqtt-producer-fluent" tabindex="0" aria-selected="true">Fluent (preferred)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_mqtt-producer-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_mqtt-producer-legacy" data-tab="mqtt-producer-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_mqtt-producer-fluent" role="tabpanel" data-tab="mqtt-producer-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddMqttEndpoints(endpoints =&gt; endpoints
                .Configure(
                    config =&gt; config
                        .WithClientId(&quot;order-service&quot;)
                        .ConnectViaTcp(&quot;localhost&quot;)
                        .SendLastWillMessage(
                            lastWill =&gt; lastWill
                                .Message(new TestamentMessage())
                                .ProduceTo(&quot;testaments&quot;)))
                .AddOutbound&lt;IIntegrationEvent&gt;(endpoint =&gt; endpoint
                    .ProduceTo(&quot;order-events&quot;)
                    .WithQualityOfServiceLevel(
                        MqttQualityOfServiceLevel.AtLeastOnce)
                    .Retain()));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-1_mqtt-producer-legacy" role="tabpanel" data-tab="mqtt-producer-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new MqttProducerEndpoint(&quot;order-events&quot;)
                {
                    Configuration =
                    {
                        ClientId = &quot;order-service&quot;,
                        ChannelOptions = new MqttClientTcpOptions
                        {
                            Server = &quot;localhost&quot;
                        },
                        WillMessage = new MqttApplicationMessage() { ... }
                    },
                    QualityOfServiceLevel = MqttQualityOfServiceLevel.AtLeastOnce,
                    Retain = true
                });
}
</code></pre>
</section>
</div>

<div class="NOTE">
<h5>Note</h5>
<p>For a more in-depth documentation about the MQTT client configuration refer also to the <a href="https://github.com/chkr1011/MQTTnet/wiki">MQTTNet documentation</a>.</p>
</div>
<h2 id="rabbitmq">RabbitMQ</h2>
<p><a href="https://www.nuget.org/packages/Silverback.Integration.RabbitMQ">Silverback.Integration.RabbitMQ</a> is a bit more intricate and uses 2 different classes to specify an endpoint that connects to a queue (<a class="xref" href="../../api/Silverback.Messaging.RabbitQueueProducerEndpoint.html">RabbitQueueProducerEndpoint</a>) or directly to an exchange (<a class="xref" href="../../api/Silverback.Messaging.RabbitExchangeProducerEndpoint.html">RabbitExchangeProducerEndpoint</a>).</p>
<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new RabbitQueueProducerEndpoint(&quot;inventory-commands-queue&quot;)
                {
                    Connection = new RabbitConnectionConfig
                    {
                        HostName = &quot;localhost&quot;,
                        UserName = &quot;guest&quot;,
                        Password = &quot;guest&quot;
                    },
                    Queue = new RabbitQueueConfig
                    {
                        IsDurable = true,
                        IsExclusive = false,
                        IsAutoDeleteEnabled = false
                    }
                })
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new RabbitExchangeProducerEndpoint(&quot;order-events&quot;)
                    {
                        Connection = new RabbitConnectionConfig
                        {
                            HostName = &quot;localhost&quot;,
                            UserName = &quot;guest&quot;,
                            Password = &quot;guest&quot;
                        },
                        Exchange = new RabbitExchangeConfig
                        {
                            IsDurable = true,
                            IsAutoDeleteEnabled = false,
                            ExchangeType = ExchangeType.Fanout
                        }
                    });
}
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>For a more in-depth documentation about the RabbitMQ configuration refer to the <a href="https://www.rabbitmq.com/getstarted.html">RabbitMQ tutorials and documentation</a>.</p>
</div>
<h2 id="transactional-outbox-strategy">Transactional outbox strategy</h2>
<p>The <a href="https://microservices.io/patterns/data/transactional-outbox.html">transactional outbox pattern</a> purpose is to reliably update the database and publish the messages in the same atomic transaction. This is achieved storing the outbound messages into a temporary outbox table, whose changes are committed together with the other changes to the rest of the data.</p>
<figure>
	<a href="../../images/diagrams/outbound-outboxtable.png"><img src="../../images/diagrams/outbound-outboxtable.png"></a>
    <figcaption>Messages 1, 2 and 3 are stored in the outbox table and produced by a separate thread or process.</figcaption>
</figure>
<p>When using entity framework the outbound messages are stored into a <code>DbSet</code> and are therefore implicitly saved in the same transaction used to save all other changes.</p>
<div class="NOTE">
<h5>Note</h5>
<p>The <a href="https://www.nuget.org/packages/Silverback.Core.EntityFrameworkCore">Silverback.Core.EntityFrameworkCore</a> package is also required and the <code>DbContext</code> must include a <code>DbSet</code> of <a class="xref" href="../../api/Silverback.Database.Model.OutboxMessage.html">OutboxMessage</a>. See also the <a class="xref" href="../dbcontext.html">Sample DbContext (EF Core)</a>.</p>
</div>
<div class="IMPORTANT">
<h5>Important</h5>
<p>The current <a class="xref" href="../../api/Silverback.Messaging.Outbound.TransactionalOutbox.OutboxWorker.html">OutboxWorker</a> cannot scale horizontally and starting multiple instances will cause the messages to be produced multiple times. In the following example a distributed lock (stored in the database) is used to ensure that only one instance is running and another one will <em>immediately</em> take over when it stops (the <code>DbContext</code> must include a <code>DbSet</code> of <a class="xref" href="../../api/Silverback.Database.Model.Lock.html">Lock</a> as well, see also the <a class="xref" href="../dbcontext.html">Sample DbContext (EF Core)</a>).</p>
</div>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-2">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_outbox-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_outbox-startup" data-tab="outbox-startup" tabindex="0" aria-selected="true">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_outbox-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_outbox-fluent" data-tab="outbox-fluent" tabindex="-1">EndpointsConfigurator (fluent)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_outbox-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_outbox-legacy" data-tab="outbox-legacy" tabindex="-1">EndpointsConfigurator (legacy)</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-2_outbox-startup" role="tabpanel" data-tab="outbox-startup">

<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .UseDbContext&lt;MyDbContext&gt;()

            // Setup the lock manager using the database
            // to handle the distributed locks.
            // If this line is omitted the OutboundWorker will still
            // work without locking. 
            .AddDbDistributedLockManager()

            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
                .AddOutboxDatabaseTable()
                .AddOutboxWorker())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-2_outbox-fluent" role="tabpanel" data-tab="outbox-fluent" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddOutbound&lt;IIntegrationEvent&gt;(
                    endpoint =&gt; endpoint
                        .ProduceTo(&quot;order-events&quot;)
                        .ProduceToOutbox()));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-2_outbox-legacy" role="tabpanel" data-tab="outbox-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new KafkaProducerEndpoint(&quot;order-events&quot;)
                {
                    Configuration = new KafkaProducerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;
                    },
                    Strategy = new OutboxProduceStrategy()
                });
}
</code></pre>
</section>
</div>
<h3 id="custom-outbox">Custom outbox</h3>
<p>You can easily use another kind of storage as outbox, simply creating your own <a class="xref" href="../../api/Silverback.Messaging.Outbound.TransactionalOutbox.Repositories.IOutboxWriter.html">IOutboxWriter</a> and <a class="xref" href="../../api/Silverback.Messaging.Outbound.TransactionalOutbox.Repositories.IOutboxReader.html">IOutboxReader</a> implementations.</p>
<p>At the moment only a database table accessed using Entity Framework is supported as outbox, but a custom storage can be used implementing <a class="xref" href="../../api/Silverback.Messaging.Outbound.TransactionalOutbox.Repositories.IOutboxWriter.html">IOutboxWriter</a> and <a class="xref" href="../../api/Silverback.Messaging.Outbound.TransactionalOutbox.Repositories.IOutboxReader.html">IOutboxReader</a>.</p>
<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .UseDbContext&lt;MyDbContext&gt;()
            .AddDbDistributedLockManager()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
                .AddOutbox&lt;MyCustomOutboxWriter, MyCustomOutboxReader()
                .AddOutboxWorker())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
}
</code></pre>
<h2 id="subscribing-locally">Subscribing locally</h2>
<p>The published messages that are routed to an outbound endpoint cannot be subscribed locally (within the same process), unless explicitly desired.</p>
<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .AddDbDistributedLockManager()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;()
            .PublishOutboundMessagesToInternalBus();
    }
}
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>What said above is only partially true, as you can subscribe to the wrapped message (<a class="xref" href="../../api/Silverback.Messaging.Messages.IOutboundEnvelope-1.html">IOutboundEnvelope&lt;TMessage&gt;</a>) even without calling <code>PublishOutboundMessagesToInternalBus</code>.</p>
</div>
<h2 id="producing-the-same-message-to-multiple-endpoints">Producing the same message to multiple endpoints</h2>
<p>An outbound route can point to multiple endpoints resulting in a broadcast to all endpoints.</p>
<figure>
	<a href="../../images/diagrams/outbound-broadcast.png"><img src="../../images/diagrams/outbound-broadcast.png"></a>
    <figcaption>Messages 1, 2 and 3 are published to both topics simultaneously.</figcaption>
</figure>
<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder)
    {
        builder
            .AddOutbound&lt;IIntegrationCommand&gt;(
                new KafkaProducerEndpoint(&quot;topic-1&quot;)
                {
                    ...
                },
                new KafkaProducerEndpoint(&quot;topic-2&quot;)
                {
                    ...
                }));
    }
}
</code></pre>
<p>A message will also be routed to all outbound endpoint mapped to a type compatible with the message type. In the example below an <code>OrderCreatedMessage</code> (that inherits from <code>OrderMessage</code>) would be sent to both endpoints.</p>
<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder)
    {
        builder
            .AddOutbound&lt;OrderMessage&gt;(
                new KafkaProducerEndpoint(&quot;topic-1&quot;)
                {
                    ...
                })
            .AddOutbound&lt;OrderCreatedMessage&gt;(
                new KafkaProducerEndpoint(&quot;topic-2&quot;)
                {
                    ...
                }));
    }
}
</code></pre>
<h2 id="dynamic-custom-routing">Dynamic custom routing</h2>
<p>By default Silverback routes the messages according to their type and the static configuration defined at startup. In some cases you may need more flexibility, being able to apply your own routing rules. More information in the dedicated <a class="xref" href="outbound-routing.html">Outbound Messages Routing</a> chapter.</p>
<h2 id="samples">Samples</h2>
<ul>
<li><a class="xref" href="../../samples/samples.html">All</a></li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/beagle1984/silverback/blob/master/docs/concepts/broker/outbound.md/#L1" class="contribution-link">Improve this doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="footer">
          <div class="container contacts">
            <a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class='fab fa-github'></i> GitHub</a>
            <a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class='fas fa-envelope'></i> E-Mail</a>
          </div>
          <div class="container">
            <span class="pull-right">
              <a href="#top">&uarr; Back to top</a>
            </span>
            © 2020 Sergio Aquilini
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
