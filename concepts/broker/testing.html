<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Testing | Silverback </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Testing | Silverback ">
    <meta name="generator" content="docfx ">
  

    <link rel="apple-touch-icon" sizes="180x180" href="../../images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../images/icons/favicon-16x16.png">
    <link rel="manifest" href="../../images/icons/site.webmanifest">
    <link rel="mask-icon" href="../../images/icons/safari-pinned-tab.svg" color="#5bbad5">

    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  <meta property="docfx:rel" content="../../">
  
    <script src="https://kit.fontawesome.com/e3306be642.js" crossorigin="anonymous"></script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="testing">
<h1 id="testing">Testing</h1>

<p>Silverback ships a mocked version of the message broker implementations on a different nuget package:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Silverback.Integration.Kafka.Testing">Silverback.Integration.Kafka.Testing</a></li>
<li><em>(coming soon)</em> <a href="https://www.nuget.org/packages/Silverback.Integration.RabbitMQ.Testing">Silverback.Integration.RabbitMQ.Testing</a></li>
</ul>
<p>These packages allow to perform end-to-end tests without having to integrate with a real message broker.</p>
<h2 id="unit-tests">Unit Tests</h2>
<p>Here an example of an xUnit test built using <a href="https://www.nuget.org/packages/Silverback.Integration.Kafka.Testing">Silverback.Integration.Kafka.Testing</a>.</p>
<pre><code class="lang-csharp">public class KafkaTests
{
    private readonly IServiceProvider _serviceProvider;

    // Configure DI during setup
    public InMemoryBrokerTests()
    {
        var services = new ServiceCollection();

        // Loggers are a prerequisite
        services.AddSingleton&lt;ILoggerFactory, NullLoggerFactory&gt;();
        services.AddSingleton(typeof(ILogger&lt;&gt;), typeof(NullLogger&lt;&gt;));

        services
            // Register Silverback as usual
            .AddSilverback()
            // Register the mocked KafkaBroker
            .WithConnectionToMessageBroker(config =&gt; config.AddMockedKafka())
            // Configure inbound and outbound endpoints
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://tests&quot;; 
                    })
                .AddOutbound&lt;InventoryEvent&gt;(endpoint =&gt; endpoint
                    .ProduceTo(&quot;test-topic&quot;))
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;test-topic&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-test-consumer&quot;;
                        })))
            // Register the subscriber under test
            .AddScopedSubscriber&lt;MySubscriber&gt;();

        // ...register all other types you need...

        _serviceProvider = services.BuildServiceProvider();
    }

    [Fact]
    public async Task SampleTest()
    {
        // Arrange

        // Connect the broker
        await _serviceProvider.GetRequiredService&lt;IBroker&gt;().ConnectAsync();

        // Create a producer to push to test-topic
        var producer = _serviceProvider
            .GetRequiredService&lt;IBroker&gt;()
            .GetProducer(new KafkaProducerEndpoint(&quot;test-topic&quot;));

        // Act
        await producer.ProduceAsync(new TestMessage { Content = &quot;hello!&quot; });
        await producer.ProduceAsync(new TestMessage { Content = &quot;hello 2!&quot; });

        // Assert
        // ...your assertions...
    }
}
</code></pre>
<h2 id="integration-tests">Integration Tests</h2>
<p>Mocking the message broker is especially interesting for the integration tests, where you probably leverage the <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests">ASP.NET Core integration tests</a> to perform a full test based on the real configuration applied in the application's startup class.</p>
<p>The following code shows the simplest integration test possible, in which an object is published to the broker and e.g. a subscriber is called.</p>
<pre><code class="lang-csharp">public class IntegrationTests : IClassFixture&lt;WebApplicationFactory&lt;Startup&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Startup&gt; _factory;

    public IntegrationTests(WebApplicationFactory&lt;Startup&gt; factory)
    {
        _factory = factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                // Replace the usual broker (KafkaBroker)
                // with the mocked version
                services.UseMockedKafka();
            });
        });
    }

    [Fact]
    public async Task SampleTest()
    {
        // Arrange

        // Resolve a producer to push to test-topic
        var producer = _factory.Server.Host.Services
            .GetRequiredService&lt;IBroker&gt;()
            .GetProducer(new KafkaProducerEndpoint(&quot;tst-topic&quot;));

        // Act
        await producer.ProduceAsync(new TestMessage { Content = &quot;abc&quot; });

        // Assert
        // ...your assertions...
    }
}
</code></pre>
<h2 id="testing-helper">Testing helper</h2>
<p>The testing helpers (such has <a class="xref" href="../../api/Silverback.Testing.IKafkaTestingHelper.html">IKafkaTestingHelper</a>) contain some methods that simplify testing with the message broker, given it's asynchronous nature.</p>
<pre><code class="lang-csharp">public class IntegrationTests : IClassFixture&lt;WebApplicationFactory&lt;Startup&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Startup&gt; _factory;

    public IntegrationTests(WebApplicationFactory&lt;Startup&gt; factory)
    {
        _factory = factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.UseMockedKafka();
            });
        });
    }

    [Fact]
    public async Task SampleTest()
    {
        // Arrange

        // Resolve the IKafkaTestingHelper (used below)
        var testingHelper = _factory.Server.Host.Services
            .GetRequiredService&lt;IKafkaTestingHelper&gt;();

        // Resolve a producer to push to test-topic
        var producer = testingHelper.Broker
            .GetProducer(new KafkaProducerEndpoint(&quot;tst-topic&quot;));

        // Act
        await producer.ProduceAsync(new TestMessage { Content = &quot;abc&quot; });

        // Wait until all messages have been consumed and 
        // committed before asserting
        await testingHelper.WaitUntilAllMessagesAreConsumedAsync();

        // Assert
        // ...your assertions...
    }
}
</code></pre>
<h2 id="integrationspy">IntegrationSpy</h2>
<p>The <a class="xref" href="../../api/Silverback.Testing.IIntegrationSpy.html">IIntegrationSpy</a> ships with the <a href="https://www.nuget.org/packages/Silverback.Integration.Testing">Silverback.Integration.Testing</a> package (referenced by the other Integration.Testing.* packages) and can be used to inspect all outbound and inbound messages.</p>
<pre><code class="lang-csharp">public class IntegrationTests : IClassFixture&lt;WebApplicationFactory&lt;Startup&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Startup&gt; _factory;

    public IntegrationTests(WebApplicationFactory&lt;Startup&gt; factory)
    {
        _factory = factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services
                    .ConfigureSilverback()
                    .UseMockedKafka()
                    .AddIntegrationSpy();
            });
        });
    }

    [Fact]
    public async Task SampleTest()
    {
        // Arrange
        var testingHelper = _factory.Server.Host.Services
            .GetRequiredService&lt;IKafkaTestingHelper&gt;();

        var producer = testingHelper.Broker
            .GetProducer(new KafkaProducerEndpoint(&quot;tst-topic&quot;));

        // Act
        await producer.ProduceAsync(new TestMessage { Content = &quot;abc&quot; });

        // Wait until all messages have been consumed and 
        // committed before asserting
        await testingHelper.WaitUntilAllMessagesAreConsumedAsync();

        // Assert
        testingHelper.Spy.OutboundEnvelopes.Should().HaveCount(1);
        testingHelper.Spy.InboundEnvelopes.Should().HaveCount(1);
        testingHelper.Spy.InboundEnvelopes[0].Message.As&lt;TestMessage&gt;
            .Content.Should().Be(&quot;abc&quot;);
    }
}
</code></pre>
<h2 id="mocked-kafka">Mocked Kafka</h2>
<p>Many aspects of the Kafka broker have been mocked to replicated as much as possible the behavior you have when connected with the real broker. This new implementation supports commits, kafka events, offset reset, partitioning, rebalance, etc.</p>
<p>The mocked topics can be retrieved and inspected via the <code>GetTopic</code> method of the <a class="xref" href="../../api/Silverback.Testing.IKafkaTestingHelper.html">IKafkaTestingHelper</a>.</p>
<h3 id="partitioning">Partitioning</h3>
<p>By default 5 partitions will be created per each topic being mocked. This number can be configured as shown in the following snippet. The setting is per broker and there's currently no way to configure each topic independently.</p>
<pre><code class="lang-csharp">public class IntegrationTests : IClassFixture&lt;WebApplicationFactory&lt;Startup&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Startup&gt; _factory;

    public IntegrationTests(WebApplicationFactory&lt;Startup&gt; factory)
    {
        _factory = factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services
                    .UseMockedKafka(options =&gt; options
                        .WithDefaultPartitionsCount(10));
            });
        });
    }
}
</code></pre>
</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/beagle1984/silverback/blob/master/docs/concepts/broker/testing.md/#L1" class="contribution-link">Improve this doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="footer">
          <div class="container contacts">
            <a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class='fab fa-github'></i> GitHub</a>
            <a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class='fas fa-envelope'></i> E-Mail</a>
          </div>
          <div class="container">
            <span class="pull-right">
              <a href="#top">&uarr; Back to top</a>
            </span>
      © 2020 Sergio Aquilini
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
