<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Outbound Connector | Silverback </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Outbound Connector | Silverback ">
    <meta name="generator" content="docfx 2.56.5.0">
    
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../images/icons/favicon-16x16.png">
    <link rel="manifest" href="../../images/icons/site.webmanifest">
    <link rel="mask-icon" href="../../images/icons/safari-pinned-tab.svg" color="#5bbad5">
  
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
    <script src="https://kit.fontawesome.com/e3306be642.js" crossorigin="anonymous"></script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="outbound">
<h1 id="outbound-connector">Outbound Connector</h1>

<p>The outbound connector is used to automatically relay the integration messages (published to the internal bus) to the message broker. Multiple outbound endpoints can be configured and Silverback will route the messages according to their type (based on the <code>TMessage</code> parameter passed to the <code>AddOutbound&lt;TMessage&gt;</code> method.</p>
<h2 id="implementations">Implementations</h2>
<p>Multiple implementations of the connector are available, offering a variable degree of reliability.</p>
<h3 id="basic">Basic</h3>
<p>The basic <code>OutboundConnector</code> is very simple and relays the messages synchronously. This is the easiest, better performing and most lightweight option but it doesn't allow for any transactionality (once the message is fired, is fired) nor resiliency to the message broker failure.</p>
<figure>
	<a href="../../images/diagrams/outbound-basic.png"><img src="../../images/diagrams/outbound-basic.png"></a>
    <figcaption>Messages 1, 2 and 3 are directly produced to the message broker.</figcaption>
</figure>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_basic-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q_basic-startup" data-tab="basic-startup" tabindex="0" aria-selected="true">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_basic-configurator" role="tab" aria-controls="tabpanel_CeZOj-G++Q_basic-configurator" data-tab="basic-configurator" tabindex="-1">EndpointsConfigurator</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_basic-startup" role="tabpanel" data-tab="basic-startup">

<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q_basic-configurator" role="tabpanel" data-tab="basic-configurator" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder)
    {
        builder
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new KafkaProducerEndpoint(&quot;basket-events&quot;)
                {
                    ...
                }));
    }
}
</code></pre>
</section>
</div>
<h3 id="deferred">Deferred</h3>
<p>The <code>DeferredOutboundConnector</code> stores the messages into a local queue to be forwarded to the message broker in a separate step.</p>
<p>This approach has two main advantages:</p>
<ol>
<li>Fault tollerance: you depend on the database only and if the message broker is unavailable the produce will be automatically retried later on</li>
<li>Transactionality: when using the database a storage you can commit the changes to the local database and the outbound messages inside a single atomic transaction (this pattern is called <a href="https://microservices.io/patterns/data/transactional-outbox.html">transactional outbox</a>)</li>
</ol>
<figure>
	<a href="../../images/diagrams/outbound-outboxtable.png"><img src="../../images/diagrams/outbound-outboxtable.png"></a>
    <figcaption>Messages 1, 2 and 3 are stored in the outbox table and produced by a separate thread or process.</figcaption>
</figure>
<h4 id="database-outbox-table">Database outbox table</h4>
<p>The <code>DbOutboundConnector</code> will store the outbound messages into a database table.</p>
<p>When using entity framework (<code>UseDbContext&lt;TDbContext&gt;</code> contained in the <code>Silverback.EntityFrameworkCore</code> package) the outbound messages are stored into a <code>DbSet</code> and are therefore implicitly saved in the same transaction used to save all other changes.</p>
<div class="NOTE">
<h5>Note</h5>
<p>The <code>DbContext</code> must include a <code>DbSet&lt;OutboundMessage&gt;</code> and an <code>OutboundWorker</code> is to be started to process the outbound queue. See also the <a class="xref" href="../06-extras/01-dbcontext.html">Sample DbContext (EF Core)</a>.</p>
</div>
<div class="IMPORTANT">
<h5>Important</h5>
<p>The current <code>OutboundWorker</code> cannot be horizontally scaled and starting multiple instances will cause the messages to be produced multiple times. In the following example a distributed lock in the database is used to ensure that only one instance is running and another one will <em>immediatly</em> take over when it stops (the <code>DbContext</code> must include a <code>DbSet&lt;Lock&gt;</code> as well, see also the <a class="xref" href="../06-extras/01-dbcontext.html">Sample DbContext (EF Core)</a>).</p>
</div>
<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()

            // Initialize Silverback to use MyDbContext as database storage.
            .UseDbContext&lt;MyDbContext&gt;()

            // Setup the lock manager using the database
            // to handle the distributed locks.
            // If this line is omitted the OutboundWorker will still
            // work without locking. 
            .AddDbDistributedLockManager()

            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
    
                // Use a deferred outbound connector
                .AddDbOutboundConnector()

                // Add the IHostedService processing the outbound queue
                // (overloads are available to specify custom interval,
                // lock timeout, etc.)
                .AddDbOutboundWorker())

            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
}
</code></pre>
<h4 id="custom-outbound-queue">Custom outbound queue</h4>
<p>You can easily create another implementation targeting another kind of storage, simply creating your own <code>IOutboundQueueWriter</code> and <code>IOutboundQueueReader</code> and plug them in.</p>
<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .AddDbDistributedLockManager()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
                .AddOutboundConnector&lt;SomeCustomQueueWriter&gt;()
                .AddOutboundWorker&lt;SomeCustomQueueReader&gt;())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
}
</code></pre>
<h2 id="subscribing-locally">Subscribing locally</h2>
<p>The published messages that are routed to an outbound endpoint cannot be subscribed locally (within the same process), unless explicitely desired.</p>
<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .AddDbDistributedLockManager()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;()
            .PublishOutboundMessagesToInternalBus();
    }
}
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>What said above is only partially true, as you can subscribe to the wrapped message (<code>IOutboundEnvelope&lt;TMessage&gt;</code>) even without calling <code>PublishOutboundMessagesToInternalBus</code>.</p>
</div>
<h2 id="producing-the-same-message-to-multiple-endpoints">Producing the same message to multiple endpoints</h2>
<p>An outbound route can point to multiple endpoints resulting in every message being broadcasted to all endpoints.</p>
<figure>
	<a href="../../images/diagrams/outbound-broadcast.png"><img src="../../images/diagrams/outbound-broadcast.png"></a>
    <figcaption>Messages 1, 2 and 3 are published to both topics simultaneously.</figcaption>
</figure>
<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder)
    {
        builder
            .AddOutbound&lt;IIntegrationCommand&gt;(
                new KafkaProducerEndpoint(&quot;topic-1&quot;)
                {
                    ...
                },
                new KafkaProducerEndpoint(&quot;topic-2&quot;)
                {
                    ...
                }));
    }
}
</code></pre>
<p>A message will also be routed to all outbound endpoint mapped to a type compatible with the message type. In the example below an <code>OrderCreatedMessage</code> (that inherits from <code>OrderMessage</code>) would be sent to both endpoints.</p>
<pre><code class="lang-csharp">```csharp
public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder)
    {
        builder
            .AddOutbound&lt;OrderMessage&gt;(
                new KafkaProducerEndpoint(&quot;topic-1&quot;)
                {
                    ...
                })
            .AddOutbound&lt;OrderCreatedMessage&gt;(
                new KafkaProducerEndpoint(&quot;topic-1&quot;)
                {
                    ...
                }));
    }
}
</code></pre>
<h2 id="dynamic-custom-routing">Dynamic custom routing</h2>
<p>By default Silverback routes the messages according to their type and the static configuration defined at startup. In some cases you may need more flexibility, being able to apply your own routing rules. In such cases it is possible to implement a fully customized router.</p>
<figure>
	<a href="../../images/diagrams/outbound-customrouting.png"><img src="../../images/diagrams/outbound-customrouting.png"></a>
    <figcaption>The messages are dynamically routed to the appropriate endpoint.</figcaption>
</figure>
<p>In the following example a custom router is used to route the messages according to their priority (a copy is also sent to a catch-all topic).</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_router" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_router" data-tab="router" tabindex="0" aria-selected="true">Router</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_router-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_router-startup" data-tab="router-startup" tabindex="-1">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_router-configurator" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_router-configurator" data-tab="router-configurator" tabindex="-1">EndpointsConfigurator</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_router" role="tabpanel" data-tab="router">

<pre><code class="lang-csharp">public class PrioritizedRouter : OutboundRouter&lt;IPrioritizedCommand&gt;
{
    private static readonly IProducerEndpoint HighPriorityEndpoint =
        new KafkaProducerEndpoint(&quot;high-priority&quot;)
        {
            ...
        };
    private static readonly IProducerEndpoint NormalPriorityEndpoint =
        new KafkaProducerEndpoint(&quot;normal-priority&quot;)
        {
            ...
        };
    private static readonly IProducerEndpoint LowPriorityEndpoint =
        new KafkaProducerEndpoint(&quot;low-priority&quot;)
        {
            ...
        };
    private static readonly IProducerEndpoint AllMessagesEndpoint =
        new KafkaProducerEndpoint(&quot;all&quot;)
        {
            ...
        };

    public override IEnumerable&lt;IProducerEndpoint&gt; Endpoints
    {
        get
        {
            yield return AllMessagesEndpoint;
            yield return LowPriorityEndpoint;
            yield return NormalPriorityEndpoint;
            yield return HighPriorityEndpoint;
        }
    }

    public override IEnumerable&lt;IProducerEndpoint&gt; GetDestinationEndpoints(
        IPrioritizedCommand message,
        MessageHeaderCollection headers)
    {
        yield return AllMessagesEndpoint;
        
        switch (message.Priority)
        {
            case MessagePriority.Low:
                yield return LowPriorityEndpoint;
                break;
            case MessagePriority.High:
                yield return HighPriorityEndpoint;
                break;
            default:
                yield return NormalPriorityEndpoint;
                break;
        }
    }
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-1_router-startup" role="tabpanel" data-tab="router-startup" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;()
            .AddSingletonOutboundRouter&lt;PrioritizedRouter&gt;();
    }
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-1_router-configurator" role="tabpanel" data-tab="router-configurator" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder)
    {
        builder.AddOutbound&lt;IPrioritizedCommand, PrioritizedRouter&gt;();
    }
}
</code></pre>
</section>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/beagle1984/silverback/blob/master/docs/concepts/02-configuration/02-outbound.md/#L1" class="contribution-link">Improve this doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="footer">
          <div class="container contacts">
            <a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class='fab fa-github'></i> GitHub</a>
            <a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class='fas fa-envelope'></i> E-Mail</a>
          </div>
          <div class="container">
            <span class="pull-right">
              <a href="#top">&uarr; Back to top</a>
            </span>
            © 2020 Sergio Aquilini
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
