<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.17.0 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Event Sourcing - Silverback - Page </title>
<meta name="description" content="Silverback.EventSourcing is a basic implementation of an event store that perfectly integrates within the Silverback ecosystem. At the moment only a version using Entity Framework Core is implemented, allowing to store the events in a database but other implementations may be added in the future.">


  <meta name="author" content="Sergio Aquilini">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Silverback">
<meta property="og:title" content="Event Sourcing">
<meta property="og:url" content="http://localhost:4000/silverback/docs/quickstart/event-sourcing">


  <meta property="og:description" content="Silverback.EventSourcing is a basic implementation of an event store that perfectly integrates within the Silverback ecosystem. At the moment only a version using Entity Framework Core is implemented, allowing to store the events in a database but other implementations may be added in the future.">







  <meta property="article:published_time" content="2020-12-13T12:38:35+01:00">






<link rel="canonical" href="http://localhost:4000/silverback/docs/quickstart/event-sourcing">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Sergio Aquilini",
      "url": "http://localhost:4000/silverback/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/silverback/feed.xml" type="application/atom+xml" rel="alternate" title="Silverback Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/silverback/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/silverback/assets/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/silverback/assets/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/silverback/assets/icons/favicon-16x16.png">
<link rel="manifest" href="/silverback/assets/icons/site.webmanifest">
<link rel="mask-icon" href="/silverback/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/silverback/"><img src="/silverback/assets/images/logo.png" alt=""></a>
        
        
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/silverback/docs/introduction" >Documentation</a>
            </li><li class="masthead__menu-item">
              <a href="/silverback/docs/releases" >Releases</a>
            </li><li class="masthead__menu-item">
              <a href="/silverback/about" >About</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/BEagle1984/silverback/" >GitHub</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          
          
          
          
          

          <a href="/silverback/docs/introduction" class="">Introduction</a>
        

        
      </li>
    
      <li>
        
          
          
          
          
          

          <a href="/silverback/docs/features" class="">Features</a>
        

        
      </li>
    
      <li>
        
          
          
          
          
          

          <a href="/silverback/docs/releases" class="">Releases</a>
        

        
      </li>
    
      <li>
        
          <span>Quickstart</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/quickstart" class="">Introduction and Glossary</a>
              

              
            </li>
          
            <li>
              
                <span>Using the Bus</span>
              

              
              <ul>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/bus" class="">Enabling the Bus</a></li>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/model" class="">Creating the Message model</a></li>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/publish" class="">Publishing</a></li>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/subscribe" class="">Subscribing</a></li>
                
              </ul>
              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/quickstart/ddd" class="">DDD and Domain Events</a>
              

              
            </li>
          
            <li>
              
                <span>Integration using a Message Broker</span>
              

              
              <ul>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/message-broker" class="">Connecting a Message Broker</a></li>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/translating" class="">Translating Messages</a></li>
                
                  
                  

                  
                  

                  <li><a href="/silverback/docs/quickstart/headers" class="">Message Headers</a></li>
                
              </ul>
              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/quickstart/behaviors" class="">Behaviors</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/quickstart/testing" class="">Testing</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/quickstart/event-sourcing" class="active">Event Sourcing</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Broker Configuration</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/configuration/endpoint" class="">Endpoint</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/configuration/outbound" class="">Outbound Connector</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/configuration/inbound" class="">Inbound Connector</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/configuration/mixed" class="">Mixed Configurations</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/configuration/external" class="">External Configuration</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Advanced</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/serialization" class="">Serialization</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/chunking" class="">Chunking</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/encryption" class="">Encryption</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/binary-files" class="">Binary Files</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/rx" class="">Observable Bus</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/broker" class="">Using IBroker</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/message-id" class="">Message Identifier</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/advanced/iinboundenvelope" class="">IInboundEnvelope</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Kafka Specific</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/kafka/message-key" class="">Message Key (partitioning)</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/kafka/multiple-consumer-groups" class="">Multiple Consumer Groups (in same process)</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/kafka/events" class="">Kafka Events</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>RabbitMQ Specific</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/rabbit/routing-key" class="">Routing Key</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Extras</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/extra/dbcontext" class="">Sample DbContext (EF Core)</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/extras/background-services" class="">Distributed Background Services</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Source Code</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/source/contributing" class="">Contributing</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/silverback/docs/source/samples" class="">Samples</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Event Sourcing">
    <meta itemprop="description" content="Silverback.EventSourcing is a basic implementation of an event store that perfectly integrates within the Silverback ecosystem. At the moment only a version using Entity Framework Core is implemented, allowing to store the events in a database but other implementations may be added in the future.">
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Event Sourcing
</h1>
          
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">In this page:</h4></header>
              <ul class="toc__menu">
  <li><a href="#configuration">Configuration</a></li>
  <li><a href="#creating-the-event-store">Creating the Event Store</a>
    <ul>
      <li><a href="#aggregate-entity-model">Aggregate Entity model</a></li>
      <li><a href="#event-store-model">Event Store model</a></li>
      <li><a href="#eventstore-repository">EventStore repository</a></li>
    </ul>
  </li>
  <li><a href="#storing-and-retrieving-entities">Storing and retrieving entities</a></li>
  <li><a href="#merging-events--handling-conflicts">Merging events / handling conflicts</a></li>
</ul>
            </nav>
          </aside>
        
        <p><code class="highlighter-rouge">Silverback.EventSourcing</code> is a basic implementation of an event store that perfectly integrates within the Silverback ecosystem. At the moment only a version using Entity Framework Core is implemented, allowing to store the events in a database but other implementations may be added in the future.</p>

<h2 id="configuration">Configuration</h2>

<p>The only needed configuration is the call to <code class="highlighter-rouge">UseDbContext&lt;TDbContext&gt;</code> when initializing Silverback.</p>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span><span class="p">.</span><span class="nf">AddSilverback</span><span class="p">().</span><span class="n">UseDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;()</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<h2 id="creating-the-event-store">Creating the Event Store</h2>

<p>Creating an event store is very straightforward and requires basically just 3 components: an aggregate entity model, the event store model and a repository.</p>

<h3 id="aggregate-entity-model">Aggregate Entity model</h3>

<p>The aggregate entity have to extend <code class="highlighter-rouge">EventSourcingDomainEntity</code> (or a custom class implementing <code class="highlighter-rouge">IEventSourcingDomainEntity</code>).
The two generic type parameters refer to the type of the key (entity unique identifier) and the base type for the domain events (can be omited if you don’t need domain events).</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span> <span class="p">:</span> <span class="n">EventSourcingDomainEntity</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">PersonDomainEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Person</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">Person</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEntityEvent</span><span class="p">&gt;</span> <span class="n">events</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">SocialSecurityNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">PhoneNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="notice--important">The domain entity must have a constructor able to rebuild the entity state from the stored events.</p>

<p>The <code class="highlighter-rouge">AddAndApplyEvent</code> protected method must be used to add new events.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span> <span class="p">:</span> <span class="n">EventSourcingDomainEntity</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">PersonDomainEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ChangeName</span><span class="p">(</span><span class="kt">string</span> <span class="n">newName</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nf">AddAndApplyEvent</span><span class="p">(</span><span class="k">new</span> <span class="n">NameChangedEvent</span>
        <span class="p">{</span>
            <span class="n">NewName</span> <span class="p">=</span> <span class="n">newName</span>
        <span class="p">});</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">ChangeAge</span><span class="p">(</span><span class="kt">int</span> <span class="n">newAge</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nf">AddAndApplyEvent</span><span class="p">(</span><span class="k">new</span> <span class="n">AgeChangedEvent</span>
        <span class="p">{</span>
            <span class="n">NewAge</span> <span class="p">=</span> <span class="n">newAge</span>
        <span class="p">});</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">ChangePhoneNumber</span><span class="p">(</span><span class="kt">string</span> <span class="n">newPhoneNumber</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nf">AddAndApplyEvent</span><span class="p">(</span><span class="k">new</span> <span class="n">PhoneNumberChangedEvent</span>
        <span class="p">{</span>
            <span class="n">NewPhoneNumber</span> <span class="p">=</span> <span class="n">newPhoneNumber</span>
        <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>An <em>Apply</em> method is needed for each event type to modify the entity current state according to the described mutation.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span> <span class="p">:</span> <span class="n">EventSourcingDomainEntity</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">PersonDomainEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">NameChangedEvent</span> <span class="n">@event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Name</span> <span class="p">=</span> <span class="n">@event</span><span class="p">.</span><span class="n">NewName</span><span class="p">;</span>
 
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">AgeChangedEvent</span> <span class="n">@event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Age</span> <span class="p">=</span> <span class="n">@event</span><span class="p">.</span><span class="n">NewAge</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">PhoneNumberChangedEvent</span> <span class="n">@event</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isReplaying</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">PhoneNumber</span> <span class="p">=</span> <span class="n">@event</span><span class="p">.</span><span class="n">NewPhoneNumber</span><span class="p">;</span>

        <span class="c1">// Fire domain event only if the event is new</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">isReplaying</span><span class="p">)</span>
            <span class="n">AddEvent</span><span class="p">&lt;</span><span class="n">PhoneNumberChangedDomainEvent</span><span class="p">&gt;();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="notice--note">The apply method can be private but it must have a specific signature: its name must begin with <em>“Apply”</em> and have a parameter of the specific event type (or base type).
It can also receive an additional boolean parameter (<code class="highlighter-rouge">isReplaying</code>) that will let you differentiate between new events and events that are being reapplied because loaded from the store.</p>

<p>The events are just models inheriting from <code class="highlighter-rouge">EntityEvent</code> (or another custom class implementing <code class="highlighter-rouge">IEntityEvent</code>).</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">NameChangedEvent</span> <span class="p">:</span> <span class="n">EntityEvent</span> 
<span class="p">{</span> 
    <span class="k">public</span> <span class="kt">string</span> <span class="n">NewName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">AgeChangedEvent</span> <span class="p">:</span> <span class="n">EntityEvent</span> 
<span class="p">{</span> 
    <span class="k">public</span> <span class="kt">int</span> <span class="n">NewAge</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PhoneNumberChangedEvent</span> <span class="p">:</span> <span class="n">EntityEvent</span> 
<span class="p">{</span> 
    <span class="k">public</span> <span class="kt">string</span> <span class="n">NewPhoneNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 
<span class="p">}</span>
</code></pre></div></div>

<h3 id="event-store-model">Event Store model</h3>

<p>The event store basically consists of an <em>EventStore</em> entity and related event (they either inherit from <code class="highlighter-rouge">EventStoreEntity</code> and <code class="highlighter-rouge">EventEntity</code> or implement the interfaces <code class="highlighter-rouge">IEventStoreEntity</code> and <code class="highlighter-rouge">IEventEntity</code> respectively).</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PersonEventStore</span> <span class="p">:</span> <span class="n">EventStoreEntity</span><span class="p">&lt;</span><span class="n">PersonEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">SocialSecurityNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PersonEvent</span> <span class="p">:</span> <span class="n">EventEntity</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="notice--note">The event store record can be extended with extra fields (see <code class="highlighter-rouge">SocialSecurityNumber</code> in the example above).</p>

<p class="notice--important">It is advised to add some indexes and a concurrency token, to ensure proper performance and consistency.</p>

<p>A DbSet must also be mapped to the defined event store entity and that’s it.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MyDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">MyDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">PersonEventStore</span><span class="p">&gt;</span> <span class="n">Persons</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="eventstore-repository">EventStore repository</h3>

<p>The repository is the component that is storing the aggregate entity in form of single events, being able to rebuild it afterwards.</p>

<p>The repository must inherit from <code class="highlighter-rouge">DbContextEventStoreRepository</code> and the 4 generic type parameters refer respectively to:</p>
<ul>
  <li>the aggregate entity</li>
  <li>its unique key</li>
  <li>the event store entity</li>
  <li>its related event entity</li>
</ul>

<p>The only thing left to implement is the mapping between the aggregate entity and the event store entity.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PersonEventStoreRepository</span>
    <span class="p">:</span> <span class="n">DbContextEventStoreRepository</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">PersonEventStore</span><span class="p">,</span> <span class="n">PersonEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">PersonEventStoreRepository</span><span class="p">(</span><span class="n">DbContext</span> <span class="n">dbContext</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">dbContext</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">PersonEventStore</span> <span class="nf">GetNewEventStoreEntity</span><span class="p">(</span>
        <span class="n">Person</span> <span class="n">aggregateEntity</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="k">new</span> <span class="n">PersonEventStore</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">aggregateEntity</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="n">SocialSecurityNumber</span> <span class="p">=</span> <span class="n">aggregateEntity</span><span class="p">.</span><span class="n">SocialSecurityNumber</span>
        <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="storing-and-retrieving-entities">Storing and retrieving entities</h2>

<p>Using the <code class="highlighter-rouge">EventStoreRepository</code> to store and retrieve aggregate entities is fairly simple. Have a look at the following code snippet to get an idea.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PersonService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MyDbContext</span> <span class="n">_dbContext</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">PersonEventStoreRepository</span> <span class="n">_repository</span> <span class="p">=</span>
        <span class="k">new</span> <span class="nf">PersonEventStoreRepository</span><span class="p">(</span><span class="n">_dbContext</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="nf">CreatePerson</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">age</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Person</span><span class="p">();</span>
        <span class="n">person</span><span class="p">.</span><span class="nf">ChangeName</span><span class="p">(</span><span class="s">"Sergio"</span><span class="p">);</span>
        <span class="n">person</span><span class="p">.</span><span class="nf">ChangeAge</span><span class="p">(</span><span class="m">35</span><span class="p">);</span>

        <span class="n">person</span> <span class="p">=</span> <span class="k">await</span> <span class="n">repo</span><span class="p">.</span><span class="nf">StoreAsync</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">_dbContext</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">person</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="nf">ChangePhoneNumber</span><span class="p">(</span>
        <span class="kt">int</span> <span class="n">personId</span><span class="p">,</span>
        <span class="kt">string</span> <span class="n">newPhoneNumber</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">person</span> <span class="p">=</span> <span class="n">repo</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">personId</span><span class="p">);</span>

        <span class="n">person</span><span class="p">.</span><span class="nf">ChangePhoneNumber</span><span class="p">(</span><span class="n">newPhoneNumber</span><span class="p">);</span>

        <span class="n">person</span> <span class="p">=</span> <span class="k">await</span> <span class="n">repo</span><span class="p">.</span><span class="nf">StoreAsync</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">_dbContext</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">person</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="merging-events--handling-conflicts">Merging events / handling conflicts</h2>

<p>You may need to merge events coming from different sources and/or being received with a certain latency. In the example below the <em>Apply</em> method checks whether another (newer) conflicting event was added already in the meantime.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">NameChangedEvent</span> <span class="n">@event</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isReplaying</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Skip if a newer event exists</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">isReplaying</span> <span class="p">&amp;&amp;</span> <span class="n">Events</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> 
        <span class="n">e</span> <span class="k">is</span> <span class="n">NameChangedEvent</span> <span class="p">&amp;&amp;</span>
        <span class="n">e</span><span class="p">.</span><span class="n">Timestamp</span> <span class="p">&gt;</span> <span class="n">@event</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Name</span> <span class="p">=</span> <span class="n">@event</span><span class="p">.</span><span class="n">NewName</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

        
      </section>

      

      

      
  <nav class="pagination">
    
      <a href="/silverback/docs/quickstart/testing" class="pagination--pager" title="Testing
">Previous</a>
    
    
      <a href="/silverback/docs/configuration/endpoint" class="pagination--pager" title="Endpoint
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
        

        
        
            
            <li><a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
            
        
            
            <li><a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope" aria-hidden="true"></i> Email</a></li>
            
        
        
    </ul>
</div>
  
<div class="page__footer-copyright">&copy; 2020 Sergio Aquilini. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; based on <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    
  <script src="/silverback/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/silverback/assets/js/lunr/lunr.min.js"></script>
<script src="/silverback/assets/js/lunr/lunr-store.js"></script>
<script src="/silverback/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
