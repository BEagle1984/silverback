<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.17.0 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Inbound Connector - Silverback - Page </title>
<meta name="description" content="The inbound connector is used to automatically consume a topic/queue and relay the messages to the internal bus.">


  <meta name="author" content="Sergio Aquilini">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Silverback">
<meta property="og:title" content="Inbound Connector">
<meta property="og:url" content="http://localhost:4000/docs/configuration/inbound">


  <meta property="og:description" content="The inbound connector is used to automatically consume a topic/queue and relay the messages to the internal bus.">







  <meta property="article:published_time" content="2020-12-28T11:14:27+01:00">






<link rel="canonical" href="http://localhost:4000/docs/configuration/inbound">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Sergio Aquilini",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Silverback Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/silverback/assets/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/silverback/assets/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/silverback/assets/icons/favicon-16x16.png">
<link rel="manifest" href="/silverback/assets/icons/site.webmanifest">
<link rel="mask-icon" href="/silverback/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt=""></a>
        
        
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/docs/introduction" >Documentation</a>
            </li><li class="masthead__menu-item">
              <a href="/docs/releases" >Releases</a>
            </li><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/BEagle1984/silverback/" >GitHub</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          
          
          
          
          

          <a href="/docs/introduction" class="">Introduction</a>
        

        
      </li>
    
      <li>
        
          
          
          
          
          

          <a href="/docs/features" class="">Features</a>
        

        
      </li>
    
      <li>
        
          
          
          
          
          

          <a href="/docs/releases" class="">Releases</a>
        

        
      </li>
    
      <li>
        
          <span>Quickstart</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/quickstart" class="">Introduction and Glossary</a>
              

              
            </li>
          
            <li>
              
                <span>Using the Bus</span>
              

              
              <ul>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/bus" class="">Enabling the Bus</a></li>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/model" class="">Creating the Message model</a></li>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/publish" class="">Publishing</a></li>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/subscribe" class="">Subscribing</a></li>
                
              </ul>
              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/quickstart/ddd" class="">DDD and Domain Events</a>
              

              
            </li>
          
            <li>
              
                <span>Integration using a Message Broker</span>
              

              
              <ul>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/message-broker" class="">Connecting a Message Broker</a></li>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/translating" class="">Translating Messages</a></li>
                
                  
                  

                  
                  

                  <li><a href="/docs/quickstart/headers" class="">Message Headers</a></li>
                
              </ul>
              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/quickstart/behaviors" class="">Behaviors</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/quickstart/testing" class="">Testing</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/quickstart/event-sourcing" class="">Event Sourcing</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Broker Configuration</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/configuration/endpoint" class="">Endpoint</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/configuration/outbound" class="">Outbound Connector</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/configuration/inbound" class="active">Inbound Connector</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/configuration/mixed" class="">Mixed Configurations</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/configuration/external" class="">External Configuration</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Advanced</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/serialization" class="">Serialization</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/chunking" class="">Chunking</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/encryption" class="">Encryption</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/binary-files" class="">Binary Files</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/rx" class="">Observable Bus</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/broker" class="">Using IBroker</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/message-id" class="">Message Identifier</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/advanced/iinboundenvelope" class="">IInboundEnvelope</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Kafka Specific</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/kafka/message-key" class="">Message Key (partitioning)</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/kafka/multiple-consumer-groups" class="">Multiple Consumer Groups (in same process)</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/kafka/events" class="">Kafka Events</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>RabbitMQ Specific</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/rabbit/routing-key" class="">Routing Key</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Extras</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/extra/dbcontext" class="">Sample DbContext (EF Core)</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/extras/background-services" class="">Distributed Background Services</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span>Source Code</span>
        

        
        <ul>
          
            <li>
              
                
                

                
                

                <a href="/docs/source/contributing" class="">Contributing</a>
              

              
            </li>
          
            <li>
              
                
                

                
                

                <a href="/docs/source/samples" class="">Samples</a>
              

              
            </li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Inbound Connector">
    <meta itemprop="description" content="The inbound connector is used to automatically consume a topic/queue and relay the messages to the internal bus.">
    <meta itemprop="datePublished" content="December 28, 2020">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Inbound Connector
</h1>
          
          
            <p class="page__date"><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated: <time datetime="2020-12-28T11:14:27+01:00">December 28, 2020</time></p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">In this page:</h4></header>
              <ul class="toc__menu">
  <li><a href="#implementations">Implementations</a>
    <ul>
      <li><a href="#basic">Basic</a></li>
      <li><a href="#exactly-once-processing">Exactly-once processing</a>
        <ul>
          <li><a href="#offset-storage">Offset storage</a></li>
          <li><a href="#logged">Logged</a></li>
          <li><a href="#custom-store">Custom store</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#error-handling">Error handling</a>
    <ul>
      <li><a href="#retries">Retries</a></li>
      <li><a href="#apply-rules">Apply rules</a></li>
      <li><a href="#publishing-messages-events">Publishing messages (events)</a></li>
    </ul>
  </li>
  <li><a href="#batch-processing">Batch processing</a></li>
  <li><a href="#multi-threaded-consuming">Multi-threaded consuming</a></li>
</ul>
            </nav>
          </aside>
        
        <p>The inbound connector is used to automatically consume a topic/queue and relay the messages to the internal bus.</p>

<p class="notice--note">The inbound connector abstracts the message broker completely and the messages are automatically acknowledged if the subscribers complete without throwing an exception (unless error handling policies are defined and unless batch processing).</p>

<h2 id="implementations">Implementations</h2>

<p>Multiple implementations are available, offering a variable degree of reliability.</p>

<h3 id="basic">Basic</h3>

<p>The basic <code class="highlighter-rouge">InboundConnector</code> is very simple and just forwards the consumed messages to the internal bus. If no exception is thrown, the message is committed and the next one is consumed.</p>

<figure>
	<a href="//assets/images/diagrams/inbound-basic.png"><img src="//assets/images/diagrams/inbound-basic.png" /></a>
    <figcaption>The messages are consumed directly.</figcaption>
</figure>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="nf">AddSilverback</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">WithConnectionToMessageBroker</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span>
                <span class="p">.</span><span class="nf">AddKafka</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">AddInboundConnector</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">BusConfigurator</span> <span class="n">busConfigurator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">busConfigurator</span>
            <span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span> <span class="n">endpoints</span>
                <span class="p">.</span><span class="nf">AddInbound</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">KafkaConsumerEndpoint</span><span class="p">(</span><span class="s">"basket-events"</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="p">...</span>
                    <span class="p">}));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<h3 id="exactly-once-processing">Exactly-once processing</h3>

<p>Silverback is able to keep track of the messages that have been consumed in order to guarantee that each message is processed exactly once.</p>

<h4 id="offset-storage">Offset storage</h4>

<p>The <code class="highlighter-rouge">DbOffsetStoredInboundConnector</code> will store the offset of the latest processed message (of each topic/partition) into a database table.</p>

<figure>
	<a href="//assets/images/diagrams/inbound-offsetstore.png"><img src="//assets/images/diagrams/inbound-offsetstore.png" /></a>
    <figcaption>The offsets are being stored to prevent the very same message to be consumed twice.</figcaption>
</figure>

<p class="notice--note">The <code class="highlighter-rouge">Silverback.EntityFrameworkCore</code> package is also required and the <code class="highlighter-rouge">DbContext</code> must include a <code class="highlighter-rouge">DbSet&lt;StoredOffset&gt;</code>. See also the <a href="//docs/extra/dbcontext">sample DbContext</a>.</p>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="nf">AddSilverback</span><span class="p">()</span>
            <span class="p">.</span><span class="n">UseDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">WithConnectionToMessageBroker</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span>
                <span class="p">.</span><span class="nf">AddKafka</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">AddDbOffsetStoredInboundConnector</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<h4 id="logged">Logged</h4>

<p>The <code class="highlighter-rouge">DbLoggedInboundConnector</code> will store all the processed messages into a database table. This has the double purpose of serving as a log in addition to preventing double processing.</p>

<figure>
	<a href="//assets/images/diagrams/inbound-log.png"><img src="//assets/images/diagrams/inbound-log.png" /></a>
    <figcaption>The inbound messages are logged to prevent two messages with the same key to be consumed.</figcaption>
</figure>

<p class="notice--note">The <code class="highlighter-rouge">Silverback.EntityFrameworkCore</code> package is also required and the <code class="highlighter-rouge">DbContext</code> must include a <code class="highlighter-rouge">DbSet&lt;InboundMessage&gt;</code>. See also the <a href="//docs/extra/dbcontext">sample DbContext</a>.</p>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="nf">AddSilverback</span><span class="p">()</span>
            <span class="p">.</span><span class="n">UseDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">WithConnectionToMessageBroker</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span>
                <span class="p">.</span><span class="nf">AddKafka</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">AddDbLoggedInboundConnector</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<h4 id="custom-store">Custom store</h4>

<p>You can easily implement your own storage for the offsets or the messages, simply creating your own <code class="highlighter-rouge">IOffsetStore</code> or <code class="highlighter-rouge">IInboundLog</code> and plugging them in.</p>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="nf">AddSilverback</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">WithConnectionToMessageBroker</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span>
                <span class="p">.</span><span class="nf">AddKafka</span><span class="p">()</span>
                <span class="p">.</span><span class="n">AddLoggedInboundConnector</span><span class="p">&lt;</span><span class="n">SomeCustomInboundLog</span><span class="p">&gt;());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="nf">AddSilverback</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">WithConnectionToMessageBroker</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span>
                <span class="p">.</span><span class="nf">AddKafka</span><span class="p">()</span>
                <span class="p">.</span><span class="n">AddOffsetStoredInboundConnector</span><span class="p">&lt;</span><span class="n">SomeCustomOffsetStore</span><span class="p">&gt;());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<h2 id="error-handling">Error handling</h2>

<p>If an exceptions is thrown by the methods consuming the incoming messages (subscribers) the consumer will stop, unless some error policies are defined.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Policy</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Skip</code></td>
      <td style="text-align: left">This is the simplest policy: just ignore the message and go ahead. Use the <code class="highlighter-rouge">LogWithLevel</code> method to specify the log level to be applied the “message skipped” log entry (default is <code class="highlighter-rouge">Error</code>).</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Retry</code></td>
      <td style="text-align: left">Define how many times and at which interval to retry to process the message. Be aware that this will block the consumer.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Move</code></td>
      <td style="text-align: left">Used to re-publish the message to the specified endpoint, this policy is very flexible and allow quite a few scenarios: move to same topic to retry later on without blocking, move to a retry topic to delay the retry or move to a failed messages topic. The message can also be transformed, to allow adding useful information (e.g. source, error type, etc.) that will allow for better handling while reprocessing.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Chain</code></td>
      <td style="text-align: left">Combine different policies, for example to move the message to a dead letter after some retries.</td>
    </tr>
  </tbody>
</table>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">BusConfigurator</span> <span class="n">busConfigurator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">busConfigurator</span>
            <span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span> <span class="n">endpoints</span>
                <span class="p">.</span><span class="nf">AddInbound</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">KafkaConsumerEndpoint</span><span class="p">(</span><span class="s">"some-events"</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="p">...</span>
                    <span class="p">},</span>
                    <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">Chain</span><span class="p">(</span>
                        <span class="n">policy</span><span class="p">.</span><span class="nf">Retry</span><span class="p">().</span><span class="nf">MaxFailedAttempts</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
                        <span class="n">policy</span><span class="p">.</span><span class="nf">Move</span><span class="p">(</span><span class="k">new</span> <span class="nf">KafkaProducerEndpoint</span><span class="p">(</span><span class="s">"bad-messages"</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="p">...</span>
                            <span class="p">}</span>
                        <span class="p">))));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<p class="notice--important">If the processing still fails after the last policy is applied the inbound connector will return the exception to the consumer, causing it to stop. A <code class="highlighter-rouge">Retry</code> (with limited amount of attempts) alone is therefore not recommendend and it should be combined with <code class="highlighter-rouge">Skip</code> or <code class="highlighter-rouge">Move</code>.</p>

<h3 id="retries">Retries</h3>

<p><code class="highlighter-rouge">Retry</code> and <code class="highlighter-rouge">Move</code> policies can be used to retry over and over the same message. Use <code class="highlighter-rouge">MaxFailedAttempts</code> to limit the number of attempts.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">policy</span><span class="p">.</span><span class="nf">Chain</span><span class="p">(</span>
    <span class="n">policy</span><span class="p">.</span><span class="nf">Retry</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">)).</span><span class="nf">MaxFailedAttempts</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
    <span class="n">policy</span><span class="p">.</span><span class="nf">Skip</span><span class="p">().</span><span class="nf">LogWithLevel</span><span class="p">(</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Critical</span><span class="p">))</span>
</code></pre></div></div>

<p class="notice--note">A message can be moved to the same topic to simply be moved to the end of the queue.</p>

<p class="notice--important">The Retry policy will prevent the message broker to be polled for the entire comulative duration of the attempts and it could lead to timeouts. With Kafka you should for example set the <code class="highlighter-rouge">max.poll.interval.ms</code> settings to an higher value.</p>

<h3 id="apply-rules">Apply rules</h3>

<p>Use <code class="highlighter-rouge">ApplyTo</code> and <code class="highlighter-rouge">Exclude</code> methods to decide which exceptions must be handled by the error policy or take advantage of  <code class="highlighter-rouge">ApplyWhen</code> to specify a custom apply rule.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">policy</span><span class="p">.</span><span class="nf">Move</span><span class="p">(</span><span class="k">new</span> <span class="nf">KafkaProducerEndpoint</span><span class="p">(</span><span class="s">"same-endpoint"</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">Exclude</span><span class="p">&lt;</span><span class="n">MyException</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">ApplyWhen</span><span class="p">((</span><span class="n">msg</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">Xy</span> <span class="p">==</span> <span class="n">myValue</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="publishing-messages-events">Publishing messages (events)</h3>

<p>Messages can be published when a policy is applied, in order to execute custom code.</p>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">BusConfigurator</span> <span class="n">busConfigurator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">busConfigurator</span>
            <span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span> <span class="n">endpoints</span>
                <span class="p">.</span><span class="nf">AddInbound</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">KafkaConsumerEndpoint</span><span class="p">(</span><span class="s">"some-events"</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="p">...</span>
                    <span class="p">},</span>
                    <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">Chain</span><span class="p">(</span>
                        <span class="n">policy</span>
                            <span class="p">.</span><span class="nf">Retry</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMilliseconds</span><span class="p">(</span><span class="m">500</span><span class="p">))</span>
                            <span class="p">.</span><span class="nf">MaxFailedAttempts</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
                        <span class="n">policy</span>
                            <span class="p">.</span><span class="nf">Skip</span><span class="p">()</span>
                            <span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">msg</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ProcessingFailedEvent</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
                    <span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">OnProcessingFailed</span><span class="p">(</span><span class="n">ProcessingFailedEvent</span> <span class="n">@event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_processingStatusService</span><span class="p">.</span><span class="nf">SetFailed</span><span class="p">(</span><span class="n">@event</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

    <span class="n">_mailService</span><span class="p">.</span><span class="nf">SendNotification</span><span class="p">(</span><span class="s">"Failed to process message!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="batch-processing">Batch processing</h2>

<p>The inbound connector can be configured to process the messages in batches.</p>

<figure>
	<a href="//assets/images/diagrams/inbound-batch.png"><img src="//assets/images/diagrams/inbound-batch.png" /></a>
    <figcaption>The messages are processed in batches.</figcaption>
</figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Property</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Batch.Size</code></td>
      <td style="text-align: left">The number of messages to be processed in batch. The default is 1.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Batch.MaxWaitTime</code></td>
      <td style="text-align: left">The maximum amount of time to wait for the batch to be filled. After this time the batch will be processed even if the desired Size is not reached. Set it to <code class="highlighter-rouge">TimeSpan.MaxValue</code> to disable this feature. The default is <code class="highlighter-rouge">TimeSpan.MaxValue</code>.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Batch.MaxDegreeOfParallelism</code></td>
      <td style="text-align: left">The maximum number of parallel threads used to process the messages in the batch. The default is 1.</td>
    </tr>
  </tbody>
</table>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">BusConfigurator</span> <span class="n">busConfigurator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">busConfigurator</span>
            <span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span> <span class="n">endpoints</span>
                <span class="p">.</span><span class="nf">AddInbound</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">KafkaConsumerEndpoint</span><span class="p">(</span><span class="s">"basket-events"</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="p">...</span>
                    <span class="p">},</span>
                    <span class="n">settings</span><span class="p">:</span> <span class="k">new</span> <span class="n">InboundConnectorSettings</span>
                    <span class="p">{</span>
                        <span class="n">Batch</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Messaging</span><span class="p">.</span><span class="n">Batch</span><span class="p">.</span><span class="n">BatchSettings</span>
                        <span class="p">{</span>
                            <span class="n">Size</span> <span class="p">=</span> <span class="m">5</span><span class="p">,</span>
                            <span class="n">MaxWaitTime</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

<p class="notice--note">The batch is consider a unit of work: it will be processed in the same DI scope, it will be atomically committed, the error policies will be applied to the batch as a whole and all messages will be acknowledged at once when the batch is successfully processed.</p>

<p>Some additional events are published to the internal bus when batch processing:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Event</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">BatchStartedEvent</code></td>
      <td style="text-align: left">Fired when the batch has been filled and just before the first message is published. This event can be subscribed to perform some operations before the messages are processed.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">BatchCompleteEvent</code></td>
      <td style="text-align: left">Fired when all the messages in a batch have been published.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">BatchProcessedEvent</code></td>
      <td style="text-align: left">Fired after all messages have been successfully processed. It can tipically be used to commit the transaction.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">BatchAbortedEvent</code></td>
      <td style="text-align: left">Fired when an exception occured during the processing of the batch. It can tipically be used to rollback the transaction.</td>
    </tr>
  </tbody>
</table>

<p>The usage should be similar to the following examples.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryService</span> <span class="p">:</span> <span class="n">ISubscriber</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">DbContext</span> <span class="n">_db</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">InventoryService</span><span class="p">(</span><span class="n">MyDbContext</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_db</span> <span class="p">=</span> <span class="n">db</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnBatchStarted</span><span class="p">(</span><span class="n">BatchStartedEvent</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span>
            <span class="s">$"Processing batch '</span><span class="p">{</span><span class="n">message</span><span class="p">.</span><span class="n">BatchId</span><span class="p">}</span><span class="s"> "</span> <span class="p">+</span>
            <span class="s">$"(</span><span class="p">{</span><span class="n">message</span><span class="p">.</span><span class="n">BatchSize</span><span class="p">}</span><span class="s"> messages)"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnMessageReceived</span><span class="p">(</span><span class="n">InventoryUpdateEvent</span> <span class="n">@event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Process the event (but don't call SaveChanges)</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnBatchProcessed</span><span class="p">(</span><span class="n">BatchProcessedEvent</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Commit all changes in a single transaction</span>
        <span class="k">await</span> <span class="n">_db</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span>
            <span class="s">$"Successfully processed batch '</span><span class="p">{</span><span class="n">message</span><span class="p">.</span><span class="n">BatchId</span><span class="p">}</span><span class="s"> "</span> <span class="p">+</span>
            <span class="s">$"(</span><span class="p">{</span><span class="n">message</span><span class="p">.</span><span class="n">BatchSize</span><span class="p">}</span><span class="s"> messages)"</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnBatchAborted</span><span class="p">(</span><span class="n">BatchAbortedEvent</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span>
            <span class="s">$"An error occurred while processing batch '</span><span class="p">{</span><span class="n">message</span><span class="p">.</span><span class="n">BatchId</span><span class="p">}</span><span class="s"> "</span> <span class="p">+</span>
            <span class="s">$"(</span><span class="p">{</span><span class="n">message</span><span class="p">.</span><span class="n">BatchSize</span><span class="p">}</span><span class="s"> messages)"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>…or…</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryService</span> <span class="p">:</span> <span class="n">ISubscriber</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">DbContext</span> <span class="n">_db</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">InventoryService</span><span class="p">(</span><span class="n">MyDbContext</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_db</span> <span class="p">=</span> <span class="n">db</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnBatchStarted</span><span class="p">(</span><span class="n">BatchStartedEvent</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnMessageReceived</span><span class="p">(</span>
        <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">InventoryUpdateEvent</span><span class="p">&gt;</span> <span class="n">events</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span>
            <span class="s">$"Processing </span><span class="p">{</span><span class="n">events</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> messages"</span><span class="p">);</span>

        <span class="c1">// Process all items</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="k">event</span> <span class="k">in</span> <span class="n">events</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>

        <span class="c1">// Commit all changes in a single transaction</span>
        <span class="k">await</span> <span class="n">_db</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span>
            <span class="s">$"Successfully processed </span><span class="p">{</span><span class="n">events</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> messages"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="notice--note">The method <code class="highlighter-rouge">OnMessageReceived</code> could declare an argument of type <code class="highlighter-rouge">IReadOnlyCollection&lt;InventoryUpdateEvent&gt;</code> instead of <code class="highlighter-rouge">IEnumerable&lt;InventoryUpdateEvent&gt;</code>. (Silverback will in any case always forward a materialized <code class="highlighter-rouge">IList</code> of messages, but explicitly declaring the paramter as <code class="highlighter-rouge">IReadOnlyCollection&lt;T&gt;</code> avoids any false positive <em>“possible multiple enumeration of IEnumerable”</em> issue that may be detected by a static code analysis tool.)</p>

<h2 id="multi-threaded-consuming">Multi-threaded consuming</h2>

<p>Multiple consumers can be created for the same endpoint to consume in parallel in multiple threads (you need multiple partitions in Kafka).</p>

<figure class="csharp">
<figcaption>Startup.cs</figcaption>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">BusConfigurator</span> <span class="n">busConfigurator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">busConfigurator</span>
            <span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span> <span class="n">endpoints</span>
                <span class="p">.</span><span class="nf">AddInbound</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">KafkaConsumerEndpoint</span><span class="p">(</span><span class="s">"basket-events"</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="p">...</span>
                    <span class="p">},</span>
                    <span class="n">settings</span><span class="p">:</span> <span class="k">new</span> <span class="n">InboundConnectorSettings</span>
                    <span class="p">{</span>
                        <span class="n">Consumers</span><span class="p">:</span> <span class="m">2</span>
                    <span class="p">}));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</figure>

        
      </section>

      

      

      
  <nav class="pagination">
    
      <a href="/docs/configuration/outbound" class="pagination--pager" title="Outbound Connector
">Previous</a>
    
    
      <a href="/docs/configuration/mixed" class="pagination--pager" title="Mixed Configurations
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
        

        
        
            
            <li><a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
            
        
            
            <li><a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope" aria-hidden="true"></i> Email</a></li>
            
        
        
    </ul>
</div>
  
<div class="page__footer-copyright">&copy; 2020 Sergio Aquilini. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; based on <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
