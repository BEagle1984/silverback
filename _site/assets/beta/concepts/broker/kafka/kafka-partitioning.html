<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Kafka Partitioning and Message Key | Silverback </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Kafka Partitioning and Message Key | Silverback ">
    <meta name="generator" content="docfx 2.56.6.0">
    
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../../images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../images/icons/favicon-16x16.png">
    <link rel="manifest" href="../../../images/icons/site.webmanifest">
    <link rel="mask-icon" href="../../../images/icons/safari-pinned-tab.svg" color="#5bbad5">
  
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    <meta property="docfx:rel" content="../../../">
    
    <script src="https://kit.fontawesome.com/e3306be642.js" crossorigin="anonymous"></script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="kafka-partitioning">
<h1 id="kafka-partitioning-and-message-key">Kafka Partitioning and Message Key</h1>

<h2 id="producer">Producer</h2>
<h3 id="destination-partition">Destination partition</h3>
<p>If the destination topic contains multiple partitions, the destination partition is picked according to the hash of the <a href="#message-key">message key</a>. If no explicit message key was set, a random one is generated, resulting in the messages being randomly spread across the partitions.</p>
<p>You can override this default behavior explicitly setting the target partition in the endpoint. The endpoint can be statically defined like in the following snippet or resolved via <a class="xref" href="../outbound-routing.html">dynamic routing</a>.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_destination-partition-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q_destination-partition-fluent" data-tab="destination-partition-fluent" tabindex="0" aria-selected="true">Fluent (preferred)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_destination-partition-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q_destination-partition-legacy" data-tab="destination-partition-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_destination-partition-fluent" role="tabpanel" data-tab="destination-partition-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddOutbound&lt;IIntegrationEvent&gt;(endpoint =&gt; endpoint
                    .ProduceTo(&quot;order-events&quot;, 2))); // &lt;- partition 2
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q_destination-partition-legacy" role="tabpanel" data-tab="destination-partition-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddOutbound&lt;IIntegrationEvent&gt;(
                new KafkaProducerEndpoint(&quot;order-events&quot;)
                {
                    Configuration = new KafkaProducerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;
                    },
                    Partition = 2
                });
}
</code></pre>
</section>
</div>

<p>Producing to a fixed partition may be required in the case you have multiple producers to the same topic and you have to prevent the messages from the different clients to be interleaved (e.g. because you are relying on sequences, like <a class="xref" href="../chunking.html">chunking</a>).</p>
<h3 id="message-key">Message key</h3>
<p>Apache Kafka require a message key for different purposes, such as:</p>
<ul>
<li><strong>Partitioning</strong>: Kafka can guarantee ordering only inside the same partition and it is therefore important to be able to route correlated messages into the same partition. To do so you need to specify a key for each message and Kafka will put all messages with the same key in the same partition.</li>
<li><strong>Compacting topics</strong>: A topic can be configured with <code>cleanup.policy=compact</code> to instruct Kafka to keep only the latest message related to a certain object, identified by the message key. In other words Kafka will retain only 1 message per each key value.</li>
</ul>
<figure>
	<a href="../../../images/diagrams/kafka-key.png"><img src="../../../images/diagrams/kafka-key.png"></a>
    <figcaption>The messages with the same key are guaranteed to be written to the same partition.</figcaption>
</figure>
<p>Silverback will always generate a message key (same value as the <code>x-message-id</code> <a class="xref" href="../headers.html">header</a>) but it also offers a convenient way to specify a custom key. It is enough to decorate the properties that must be part of the key with <a class="xref" href="../../../api/Silverback.Messaging.Messages.KafkaKeyMemberAttribute.html">KafkaKeyMemberAttribute</a>.</p>
<pre><code class="lang-csharp">public class MultipleKeyMembersMessage : IIntegrationMessage
{
    public Guid Id { get; set; }

    [KafkaKeyMember]
    public string One { get; set; }
    
    [KafkaKeyMember]
    public string Two { get; set; }

    public string Three { get; set; }
}
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>The message key will also be received as header (see <a class="xref" href="../headers.html">Message Headers</a> for details).</p>
</div>
<h2 id="consumer">Consumer</h2>
<h3 id="partitions-processing">Partitions processing</h3>
<p>While using a single poll loop, Silverback processes the messages consumed from each Kafka partition independently and concurrently.</p>
<p>By default up to 10 messages/partitions are processed concurrently (per topic). This value can be tweaked in the endpoint configuration or disabled completely.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_concurrency-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_concurrency-fluent" data-tab="concurrency-fluent" tabindex="0" aria-selected="true">Fluent</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_concurrency-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_concurrency-legacy" data-tab="concurrency-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_concurrency-fluent" role="tabpanel" data-tab="concurrency-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;order-events&quot;)
                    .LimitParallelism(2)
                    .Configure(config =&gt;
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;inventory-events&quot;)
                    .ProcessAllPartitionsTogether()
                    .Configure(config =&gt;
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-1_concurrency-legacy" role="tabpanel" data-tab="concurrency-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(&quot;order-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;,
                    },
                    MaxDegreeOfParallelism = 2 
                })
            .AddInbound(
                new KafkaConsumerEndpoint(&quot;inventory-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;,
                    },
                    ProcessPartitionsIndependently = false 
                });
}
</code></pre>
</section>
</div>
<h3 id="manual-partitions-assignment">Manual partitions assignment</h3>
<p>In some cases you don't want to let the broker randomly distribute the partitions among the consumers. This is especially useful when dealing with large sequences (e.g. large messages/files being <a class="xref" href="../chunking.html">chunked</a>), to prevent that a rebalance occurs in the middle of a sequence, forcing the consumer to abort and restart from the beginning.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-2">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_assignment-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_assignment-fluent" data-tab="assignment-fluent" tabindex="0" aria-selected="true">Fluent</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_assignment-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_assignment-legacy" data-tab="assignment-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-2_assignment-fluent" role="tabpanel" data-tab="assignment-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(
                        new TopicPartition(&quot;order-events&quot;, 0),
                        new TopicPartition(&quot;order-events&quot;, 1))
                    .Configure(config =&gt;
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-2_assignment-legacy" role="tabpanel" data-tab="assignment-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(
                    new TopicPartition(&quot;order-events&quot;, 0),
                    new TopicPartition(&quot;order-events&quot;, 1))
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;,
                    } 
                });
}
</code></pre>
</section>
</div>
<h2 id="samples">Samples</h2>
<ul>
<li><a class="xref" href="../../../samples/kafka/binaryfile-streaming.html">Kafka - Files Streaming</a></li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/beagle1984/silverback/blob/master/docs/concepts/broker/kafka/kafka-partitioning.md/#L1" class="contribution-link">Improve this doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="footer">
          <div class="container contacts">
            <a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class='fab fa-github'></i> GitHub</a>
            <a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class='fas fa-envelope'></i> E-Mail</a>
          </div>
          <div class="container">
            <span class="pull-right">
              <a href="#top">&uarr; Back to top</a>
            </span>
            © 2020 Sergio Aquilini
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
