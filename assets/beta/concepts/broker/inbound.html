<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Inbound Endpoint | Silverback </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Inbound Endpoint | Silverback ">
    <meta name="generator" content="docfx 2.56.6.0">
    
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../images/icons/favicon-16x16.png">
    <link rel="manifest" href="../../images/icons/site.webmanifest">
    <link rel="mask-icon" href="../../images/icons/safari-pinned-tab.svg" color="#5bbad5">
  
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
    <script src="https://kit.fontawesome.com/e3306be642.js" crossorigin="anonymous"></script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="inbound">
<h1 id="inbound-endpoint">Inbound Endpoint</h1>

<p>An inbound endpoint is used to configure Silverback to automatically consume a topic/queue and relay the messages to the internal bus. If no exception is thrown by the subscribers, the message is acknowledged and the next one is consumed.</p>
<p>The endpoint object identifies the topic/queue that is being connected and the client configuration, such the connection options. The endpoint object is therefore very specific and every broker type will define it's own implementation of <a class="xref" href="../../api/Silverback.Messaging.IConsumerEndpoint.html">IConsumerEndpoint</a>.</p>
<p>The options in the endpoint object are also used to tweak the Silverback behavior (e.g. the <a class="xref" href="serialization.html">deserialization</a>) and to enable additional features such as <a href="#batch-processing">batch consuming</a>, <a class="xref" href="encryption.html">decryption</a>, etc.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Silverback abstracts the message broker completely and the messages are automatically acknowledged if the subscribers complete without throwing an exception.</p>
</div>
<h2 id="apache-kafka">Apache Kafka</h2>
<p>The <a class="xref" href="../../api/Silverback.Messaging.KafkaConsumerEndpoint.html">KafkaConsumerEndpoint</a> is defined by
<a href="https://www.nuget.org/packages/Silverback.Integration.Kafka">Silverback.Integration.Kafka</a> and is used to declare an inbound endpoint connected to Apache Kafka.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_kafka-consumer-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q_kafka-consumer-fluent" data-tab="kafka-consumer-fluent" tabindex="0" aria-selected="true">Fluent (preferred)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_kafka-consumer-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q_kafka-consumer-legacy" data-tab="kafka-consumer-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_kafka-consumer-fluent" role="tabpanel" data-tab="kafka-consumer-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;order-events&quot;, &quot;inventory-events&quot;)
                    .Configure(config =&gt;
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                            config.AutoOffsetReset = AutoOffsetResetType.Earliest;
                        }
                    .OnError(policy =&gt; policy.Retry(5))));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q_kafka-consumer-legacy" role="tabpanel" data-tab="kafka-consumer-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(
                    &quot;order-events&quot;, 
                    &quot;inventory-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;,
                        AutoOffsetReset = AutoOffsetResetType.Earliest
                    },
                    ErrorPolicy = new RetryErrorPolicy().MaxFailedAttempts(5) 
                });
}
</code></pre>
</section>
</div>

<div class="NOTE">
<h5>Note</h5>
<p>You can decide whether to use one consumer per topic or subscribe multiple topics with the same consumer (passing multiple topic names in the endpoint constructor, as shown in the example above). There are advantages and disadvantages of both solutions and the best choice really depends on your specific requirements, the amount of messages being produced, etc. Anyway the main difference is that when subscribing multiple topics you will still consume one message after the other but they will simply be interleaved (this may or may not be an issue, it depends) and on the other hand each consumer will use some resources, so creating multiple consumers will result in a bigger overhead.</p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>For a more in-depth documentation about the Kafka client configuration refer also to the <a href="https://docs.confluent.io/current/clients/confluent-kafka-dotnet/api/Confluent.Kafka.html">confluent-kafka-dotnet documentation</a>.</p>
</div>
<h2 id="mqtt">MQTT</h2>
<p>The <a class="xref" href="../../api/Silverback.Messaging.MqttConsumerEndpoint.html">MqttConsumerEndpoint</a> is defined by
<a href="https://www.nuget.org/packages/Silverback.Integration.MQTT">Silverback.Integration.MQTT</a> and is used to declare an inbound endpoint connected to an MQTT broker.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_mqtt-consumer-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_mqtt-consumer-fluent" data-tab="mqtt-consumer-fluent" tabindex="0" aria-selected="true">Fluent (preferred)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_mqtt-consumer-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_mqtt-consumer-legacy" data-tab="mqtt-consumer-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_mqtt-consumer-fluent" role="tabpanel" data-tab="mqtt-consumer-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddMqttEndpoints(endpoints =&gt; endpoints
                .Configure(
                    config =&gt; config
                        .WithClientId(&quot;order-service&quot;)
                        .ConnectViaTcp(&quot;localhost&quot;)
                        .SendLastWillMessage(
                            lastWill =&gt; lastWill
                                .Message(new TestamentMessage())
                                .ProduceTo(&quot;testaments&quot;)))
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;order-events&quot;, &quot;inventory-events&quot;)
                    .WithQualityOfServiceLevel(
                        MqttQualityOfServiceLevel.AtLeastOnce)
                    .OnError(policy =&gt; policy.Retry(5))));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-1_mqtt-consumer-legacy" role="tabpanel" data-tab="mqtt-consumer-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new MqttConsumerEndpoint(
                    &quot;order-events&quot;, 
                    &quot;inventory-events&quot;)
                {
                    Configuration =
                    {
                        ClientId = &quot;order-service&quot;,
                        ChannelOptions = new MqttClientTcpOptions
                        {
                            Server = &quot;localhost&quot;
                        },
                        WillMessage = new MqttApplicationMessage() { ... }
                    },
                    QualityOfServiceLevel = MqttQualityOfServiceLevel.AtLeastOnce
                    ErrorPolicy = new RetryErrorPolicy().MaxFailedAttempts(5) 
                });
}
</code></pre>
</section>
</div>

<div class="NOTE">
<h5>Note</h5>
<p>It doesn't matter how you configure the inbound and outbound endpoints, a single client will be created as long as all endpoints match the exact same configuration. (Using a slightly different configuration for the same client it will cause an exception to be thrown when validating the endpoints configuration.)</p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>For a more in-depth documentation about the MQTT client configuration refer also to the <a href="https://github.com/chkr1011/MQTTnet/wiki">MQTTNet documentation</a>.</p>
</div>
<h2 id="rabbitmq">RabbitMQ</h2>
<p><a href="https://www.nuget.org/packages/Silverback.Integration.RabbitMQ">Silverback.Integration.RabbitMQ</a> is a bit more intricate and uses 2 different classes to specify an endpoint that connects to a queue (<a class="xref" href="../../api/Silverback.Messaging.RabbitQueueConsumerEndpoint.html">RabbitQueueConsumerEndpoint</a>) or directly to an exchange (<a class="xref" href="../../api/Silverback.Messaging.RabbitExchangeConsumerEndpoint.html">RabbitExchangeConsumerEndpoint</a>).</p>
<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new RabbitQueueConsumerEndpoint(&quot;inventory-commands-queue&quot;)
                {
                    Connection = new RabbitConnectionConfig
                    {
                        HostName = &quot;localhost&quot;,
                        UserName = &quot;guest&quot;,
                        Password = &quot;guest&quot;
                    },
                    Queue = new RabbitQueueConfig
                    {
                        IsDurable = true,
                        IsExclusive = false,
                        IsAutoDeleteEnabled = false
                    }
                })
            .AddInbound(
                new RabbitExchangeConsumerEndpoint(&quot;order-events&quot;)
                {
                    Connection = new RabbitConnectionConfig
                    {
                        HostName = &quot;localhost&quot;,
                        UserName = &quot;guest&quot;,
                        Password = &quot;guest&quot;
                    },
                    Exchange = new RabbitExchangeConfig
                    {
                        IsDurable = true,
                        IsAutoDeleteEnabled = false,
                        ExchangeType = ExchangeType.Fanout
                    },
                    QueueName = &quot;my-consumer-group&quot;,
                    Queue = new RabbitQueueConfig
                    {
                        IsDurable = true,
                        IsExclusive = false,
                        IsAutoDeleteEnabled = false
                    }
                });
}
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>For a more in-depth documentation about the RabbitMQ configuration refer to the <a href="https://www.rabbitmq.com/getstarted.html">RabbitMQ tutorials and documentation</a>.</p>
</div>
<h2 id="error-handling">Error handling</h2>
<p>If an exceptions is thrown by the methods consuming the incoming messages (subscribers) the consumer will stop, unless some error policies are defined.</p>
<p>The built-in policies are:</p>
<ul>
<li><a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.StopConsumerErrorPolicy.html">StopConsumerErrorPolicy</a> (default)</li>
<li><a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.SkipMessageErrorPolicy.html">SkipMessageErrorPolicy</a></li>
<li><a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.RetryErrorPolicy.html">RetryErrorPolicy</a></li>
<li><a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.MoveMessageErrorPolicy.html">MoveMessageErrorPolicy</a></li>
<li><a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.ErrorPolicyChain.html">ErrorPolicyChain</a></li>
</ul>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-2">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_error-handling-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_error-handling-fluent" data-tab="error-handling-fluent" tabindex="0" aria-selected="true">Fluent</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_error-handling-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_error-handling-legacy" data-tab="error-handling-legacy" tabindex="-1">Legacy</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-2_error-handling-fluent" role="tabpanel" data-tab="error-handling-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;order-events&quot;, &quot;inventory-events&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                            config.AutoOffsetReset = AutoOffsetResetType.Earliest; 
                        })
                    .OnError(policy =&gt; policy
                        .Retry(3, TimeSpan.FromSeconds(1))
                        .ThenSkip())));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-2_error-handling-legacy" role="tabpanel" data-tab="error-handling-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(
                    &quot;order-events&quot;, 
                    &quot;inventory-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;,
                        AutoOffsetReset = AutoOffsetResetType.Earliest
                    },
                    ErrorPolicy = new ErrorPolicyChain(
                        new RetryErrorPolicy().MaxFailedAttempts(5),
                        new SkipErrorPolicy()) 
                });
}
</code></pre>
</section>
</div>

<div class="IMPORTANT">
<h5>Important</h5>
<p>If the processing still fails after the last policy is applied the exception will be returned to the consumer, causing it to stop.</p>
</div>
<div class="IMPORTANT">
<h5>Important</h5>
<p>The number of attempts are tracked according to the message id <a class="xref" href="headers.html">header</a>. A message id must be provided in order for the <code>MaxFailedAttempts</code> mechanism to work. This is ensured by the Silverback producer but might not be the case when consuming messages coming from other sources.
Some message broker implementations might transparently cope with the missing message id header and derive it from other identifiers (e.g. the kafka message key) but it's not automatically guaranteed that they will always be unique. You should carefully check that before relying on this feature.</p>
</div>
<div class="IMPORTANT">
<h5>Important</h5>
<p>The <a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.RetryErrorPolicy.html">RetryErrorPolicy</a> will prevent the message broker to be polled for the duration of the configured delay, which could lead to a timeout. With Kafka you should for example set the <code>max.poll.interval.ms</code> settings to an higher value.</p>
</div>
<h3 id="apply-rules">Apply rules</h3>
<p>Use <a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.ErrorPolicyBase.html#Silverback_Messaging_Inbound_ErrorHandling_ErrorPolicyBase_ApplyTo_System_Type_">ApplyTo</a> and <a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.ErrorPolicyBase.html#Silverback_Messaging_Inbound_ErrorHandling_ErrorPolicyBase_Exclude_System_Type_">Exclude</a> methods to decide which exceptions must be handled by the error policy or take advantage of <a class="xref" href="../../api/Silverback.Messaging.Inbound.ErrorHandling.ErrorPolicyBase.html#Silverback_Messaging_Inbound_ErrorHandling_ErrorPolicyBase_ApplyWhen_System_Func_Silverback_Messaging_Messages_IRawInboundEnvelope_System_Exception_System_Boolean__">ApplyWhen</a> to specify a custom apply rule.</p>
<pre><code class="lang-csharp">.OnError(policy =&gt; policy
    .MoveToKafkaTopic(
        moveEndpoint =&gt; moveEndpoint.ProduceTo(&quot;some-other-topic&quot;),
        movePolicy =&gt; movePolicy
            .ApplyTo&lt;MyException&gt;()
            .ApplyWhen((msg, ex) =&gt; msg.Xy == myValue))
    .ThenSkip());
</code></pre>
<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;order-events&quot;, &quot;inventory-events&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })
                    .OnError(policy =&gt; policy
                        .MoveToKafkaTopic(
                            moveEndpoint =&gt; moveEndpoint.ProduceTo(&quot;some-other-topic&quot;),
                            movePolicy =&gt; movePolicy
                                .ApplyTo&lt;MyException&gt;()
                                .ApplyWhen((msg, ex) =&gt; msg.Xy == myValue))
                        .ThenSkip())));
}
</code></pre>
<h3 id="publishing-events">Publishing events</h3>
<p>Messages can be published when a policy is applied, in order to execute custom code.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-3">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-3_eventhandler-configurator" role="tab" aria-controls="tabpanel_CeZOj-G++Q-3_eventhandler-configurator" data-tab="eventhandler-configurator" tabindex="0" aria-selected="true">EndpointsConfigurator</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-3_eventhandler" role="tab" aria-controls="tabpanel_CeZOj-G++Q-3_eventhandler" data-tab="eventhandler" tabindex="-1">Event Handler</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-3_eventhandler-configurator" role="tabpanel" data-tab="eventhandler-configurator">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;order-events&quot;, &quot;inventory-events&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })
                    .OnError(policy =&gt; policy
                        .Retry(3, TimeSpan.FromSeconds(1))
                        .ThenSkip(skipPolicy =&gt; skipPolicy
                            .Publish(msg =&gt; new ProcessingFailedEvent(msg))))));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-3_eventhandler" role="tabpanel" data-tab="eventhandler" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public void OnProcessingFailed(ProcessingFailedEvent @event)
{
    _processingStatusService.SetFailed(@event.Message.Id);

    _mailService.SendNotification(&quot;Failed to process message!&quot;);
}
</code></pre>
</section>
</div>
<h2 id="batch-processing">Batch processing</h2>
<p>In some scenario, when having to deal with huge amounts of messages, processing each one of them on its own isn't the most efficient approach. Batch processing allow to process an arbitrary number of unrelated messages as a single unit of work.</p>
<figure>
	<a href="../../images/diagrams/inbound-batch.png"><img src="../../images/diagrams/inbound-batch.png"></a>
    <figcaption>The messages are processed in batches.</figcaption>
</figure>
<p>Refer to the <a class="xref" href="../../api/Silverback.Messaging.Sequences.Batch.BatchSettings.html">BatchSettings</a> documentation for details about the configuration.</p>
<p>The batch can be subscribed either as <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.ienumerable-1">IEnumerable<t></t></a>, <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.iasyncenumerable-1">IAsyncEnumerable<t></t></a> or <a class="xref" href="../../api/Silverback.Messaging.Messages.IMessageStreamEnumerable-1.html">IMessageStreamEnumerable&lt;TMessage&gt;</a>. See also <a class="xref" href="streaming.html">Streaming</a> for details.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-4">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-4_batch-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-4_batch-fluent" data-tab="batch-fluent" tabindex="0" aria-selected="true">EndpointsConfigurator (fluent)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-4_batch-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-4_batch-legacy" data-tab="batch-legacy" tabindex="-1">EndpointsConfigurator (legacy)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-4_batch-subscriber" role="tab" aria-controls="tabpanel_CeZOj-G++Q-4_batch-subscriber" data-tab="batch-subscriber" tabindex="-1">Subscriber</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-4_batch-fluent" role="tabpanel" data-tab="batch-fluent">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;inventory-events&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })
                    .EnableBatchProcessing(100, TimeSpan.FromSeconds(5))));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-4_batch-legacy" role="tabpanel" data-tab="batch-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(&quot;inventory-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;
                    },
                    Batch = new Messaging.Batch.BatchSettings
                    {
                        Size = 100,
                        MaxWaitTime = TimeSpan.FromSeconds(5)
                    }
                });
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-4_batch-subscriber" role="tabpanel" data-tab="batch-subscriber" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class InventoryService
{
    private DbContext _db;

    public InventoryService(MyDbContext db)
    {
        _db = db;
    }

    public async Task OnUpdateBatchReceived(IAsyncEnumerable&lt;InventoryUpdateEvent&gt; events)
    {
        async foreach (var event in events)
        {
            // Process each message
        }

        // Commit all changes in a single transaction
        await _db.SaveChangesAsync();
    }
}
</code></pre>
</section>
</div>
<h2 id="parallelism">Parallelism</h2>
<p>The consumer processes the messages sequentially, this is by design.</p>
<p>The <a class="xref" href="../../api/Silverback.Messaging.Broker.KafkaConsumer.html">KafkaConsumer</a> is a bit special and actually processes each assigned partition independently and concurrently.</p>
<p>This feature can be toggled using the <a class="xref" href="../../api/Silverback.Messaging.Configuration.Kafka.IKafkaConsumerEndpointBuilder.html#Silverback_Messaging_Configuration_Kafka_IKafkaConsumerEndpointBuilder_ProcessAllPartitionsTogether">ProcessAllPartitionsTogether</a> and <a class="xref" href="../../api/Silverback.Messaging.Configuration.Kafka.IKafkaConsumerEndpointBuilder.html#Silverback_Messaging_Configuration_Kafka_IKafkaConsumerEndpointBuilder_ProcessPartitionsIndependently">ProcessPartitionsIndependently</a> methods of the <a class="xref" href="../../api/Silverback.Messaging.Configuration.Kafka.IKafkaConsumerEndpointBuilder.html">IKafkaConsumerEndpointBuilder</a> (or the <a class="xref" href="../../api/Silverback.Messaging.KafkaConsumerEndpoint.html#Silverback_Messaging_KafkaConsumerEndpoint_ProcessPartitionsIndependently">KafkaConsumerEndpoint.ProcessPartitionsIndependently</a> property), while the <a class="xref" href="../../api/Silverback.Messaging.Configuration.Kafka.IKafkaConsumerEndpointBuilder.html#Silverback_Messaging_Configuration_Kafka_IKafkaConsumerEndpointBuilder_LimitParallelism_System_Int32_">LimitParallelism</a> method (or the <a class="xref" href="../../api/Silverback.Messaging.KafkaConsumerEndpoint.html#Silverback_Messaging_KafkaConsumerEndpoint_MaxDegreeOfParallelism">KafkaConsumerEndpoint.MaxDegreeOfParallelism</a> property) can be used to limit the number of messages being actually processed concurrently.</p>
<h2 id="exactly-once-processing">Exactly-once processing</h2>
<p>Silverback is able to keep track of the messages that have been consumed in order to guarantee that each message is processed exactly once.</p>
<h3 id="offset-storage">Offset storage</h3>
<p>The <a class="xref" href="../../api/Silverback.Messaging.Inbound.ExactlyOnce.OffsetStoreExactlyOnceStrategy.html">OffsetStoreExactlyOnceStrategy</a> will store the offset of the latest processed message (of each topic/partition) into a database table.</p>
<figure>
	<a href="../../images/diagrams/inbound-offsetstore.png"><img src="../../images/diagrams/inbound-offsetstore.png"></a>
    <figcaption>The offsets are being stored to prevent the very same message to be consumed twice.</figcaption>
</figure>
<div class="NOTE">
<h5>Note</h5>
<p>The <a href="https://www.nuget.org/packages/Silverback.Core.EntityFrameworkCore">Silverback.Core.EntityFrameworkCore</a> package is also required and the <code>DbContext</code> must include a <code>DbSet</code> of <a class="xref" href="../../api/Silverback.Database.Model.StoredOffset.html">StoredOffset</a>. See also the <a class="xref" href="../dbcontext.html">Sample DbContext (EF Core)</a>.</p>
</div>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-5">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-5_offsetstore-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q-5_offsetstore-startup" data-tab="offsetstore-startup" tabindex="0" aria-selected="true">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-5_offsetstore-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-5_offsetstore-fluent" data-tab="offsetstore-fluent" tabindex="-1">EndpointsConfigurator (fluent)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-5_offsetstore-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-5_offsetstore-legacy" data-tab="offsetstore-legacy" tabindex="-1">EndpointsConfigurator (legacy)</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-5_offsetstore-startup" role="tabpanel" data-tab="offsetstore-startup">

<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .UseDbContext&lt;MyDbContext&gt;()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
                .AddOffsetStoreDatabaseTable())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
} 
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-5_offsetstore-fluent" role="tabpanel" data-tab="offsetstore-fluent" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;inventory-events&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })
                    .EnsureExactlyOnce(strategy =&gt; strategy.StoreOffsets())));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-5_offsetstore-legacy" role="tabpanel" data-tab="offsetstore-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(&quot;inventory-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;
                    },
                    ExactlyOnceStrategy = new OffsetStoreExactlyOnceStrategy()
                });
}
</code></pre>
</section>
</div>
<h3 id="inbound-log">Inbound log</h3>
<p>The <a class="xref" href="../../api/Silverback.Messaging.Inbound.ExactlyOnce.LogExactlyOnceStrategy.html">LogExactlyOnceStrategy</a> will store the identifiers of all processed messages into a database table.</p>
<figure>
	<a href="../../images/diagrams/inbound-log.png"><img src="../../images/diagrams/inbound-log.png"></a>
    <figcaption>The inbound messages are logged to prevent two messages with the same key to be consumed.</figcaption>
</figure>
<div class="NOTE">
<h5>Note</h5>
<p>The <a href="https://www.nuget.org/packages/Silverback.Core.EntityFrameworkCore">Silverback.Core.EntityFrameworkCore</a> package is also required and the <code>DbContext</code> must include a <code>DbSet</code> of <a class="xref" href="../../api/Silverback.Database.Model.InboundLogEntry.html">InboundLogEntry</a>. See also the <a class="xref" href="../dbcontext.html">Sample DbContext (EF Core)</a>.</p>
</div>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-6">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-6_log-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q-6_log-startup" data-tab="log-startup" tabindex="0" aria-selected="true">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-6_log-fluent" role="tab" aria-controls="tabpanel_CeZOj-G++Q-6_log-fluent" data-tab="log-fluent" tabindex="-1">EndpointsConfigurator (fluent)</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-6_log-legacy" role="tab" aria-controls="tabpanel_CeZOj-G++Q-6_log-legacy" data-tab="log-legacy" tabindex="-1">EndpointsConfigurator (legacy)</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-6_log-startup" role="tabpanel" data-tab="log-startup">

<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .UseDbContext&lt;MyDbContext&gt;()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
                .AddInboundLogDatabaseTable())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
} 
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-6_log-fluent" role="tabpanel" data-tab="log-fluent" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddKafkaEndpoints(endpoints =&gt; endpoints
                .Configure(config =&gt; 
                    {
                        config.BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;; 
                    })
                .AddInbound(endpoint =&gt; endpoint
                    .ConsumeFrom(&quot;inventory-events&quot;)
                    .Configure(config =&gt; 
                        {
                            config.GroupId = &quot;my-consumer&quot;;
                        })
                    .EnsureExactlyOnce(strategy =&gt; strategy.LogMessages())));
}
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q-6_log-legacy" role="tabpanel" data-tab="log-legacy" aria-hidden="true" hidden="hidden">

<pre><code class="lang-csharp">public class MyEndpointsConfigurator : IEndpointsConfigurator
{
    public void Configure(IEndpointsConfigurationBuilder builder) =&gt;
        builder
            .AddInbound(
                new KafkaConsumerEndpoint(&quot;inventory-events&quot;)
                {
                    Configuration = new KafkaConsumerConfig
                    {
                        BootstrapServers = &quot;PLAINTEXT://kafka:9092&quot;,
                        GroupId = &quot;my-consumer&quot;
                    },
                    ExactlyOnceStrategy = new LogExactlyOnceStrategy()
                });
}
</code></pre>
</section>
</div>
<h3 id="custom-store">Custom store</h3>
<p>At the moment only a database accessed using Entity Framework is supported as offset or log storage, but a custom storage can be used implementing <a class="xref" href="../../api/Silverback.Messaging.Inbound.ExactlyOnce.Repositories.IOffsetStore.html">IOffsetStore</a> or <a class="xref" href="../../api/Silverback.Messaging.Inbound.ExactlyOnce.Repositories.IInboundLog.html">IInboundLog</a>.</p>
<pre><code class="lang-csharp">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddSilverback()
            .UseDbContext&lt;MyDbContext&gt;()
            .WithConnectionToMessageBroker(options =&gt; options
                .AddKafka()
                .AddOffsetStore&lt;MyCustomOffsetStore&gt;())
            .AddEndpointsConfigurator&lt;MyEndpointsConfigurator&gt;();
    }
} 
</code></pre>
<h2 id="samples">Samples</h2>
<ul>
<li><a class="xref" href="../../samples/samples.html">All</a></li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/beagle1984/silverback/blob/master/docs/concepts/broker/inbound.md/#L1" class="contribution-link">Improve this doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="footer">
          <div class="container contacts">
            <a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class='fab fa-github'></i> GitHub</a>
            <a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class='fas fa-envelope'></i> E-Mail</a>
          </div>
          <div class="container">
            <span class="pull-right">
              <a href="#top">&uarr; Back to top</a>
            </span>
            © 2020 Sergio Aquilini
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
