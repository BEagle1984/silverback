<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>MQTT - Files Streaming | Silverback </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="MQTT - Files Streaming | Silverback ">
    <meta name="generator" content="docfx 2.56.6.0">
    
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../images/icons/favicon-16x16.png">
    <link rel="manifest" href="../../images/icons/site.webmanifest">
    <link rel="mask-icon" href="../../images/icons/safari-pinned-tab.svg" color="#5bbad5">
  
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
    <script src="https://kit.fontawesome.com/e3306be642.js" crossorigin="anonymous"></script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="sample-mqtt-binaryfile">
<h1 id="mqtt---files-streaming">MQTT - Files Streaming</h1>

<p>This sample demonstrates how to deal with raw binary contents and large messages, to transfer some files through Mqtt.</p>
<p>See also: <a class="xref" href="../../concepts/broker/binary-files.html">Binary Files</a>, <a class="xref" href="../../concepts/broker/chunking.html">Chunking</a></p>
<h2 id="producer">Producer</h2>
<p>The producer exposes two REST API that receive the path of a local file to be streamed. The second API uses a custom <code>BinaryFileMessage</code> to forward further metadata (the file name in this example).</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_producer-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q_producer-startup" data-tab="producer-startup" tabindex="0" aria-selected="true">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_producer-endpoints" role="tab" aria-controls="tabpanel_CeZOj-G++Q_producer-endpoints" data-tab="producer-endpoints" tabindex="-1">EndpointsConfigurator</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_producer-custom-message" role="tab" aria-controls="tabpanel_CeZOj-G++Q_producer-custom-message" data-tab="producer-custom-message" tabindex="-1">CustomBinaryFileMessage</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_producer-controller" role="tab" aria-controls="tabpanel_CeZOj-G++Q_producer-controller" data-tab="producer-controller" tabindex="-1">API Controller</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_producer-startup" role="tabpanel" data-tab="producer-startup">
<pre><code class="lang-csharp" name="Producer.Startup">using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.DependencyInjection;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Producer
{
    public class Startup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            // Enable Silverback
            services
                .AddSilverback()

                // Use Apache Mqtt as message broker
                .WithConnectionToMessageBroker(
                    options =&gt; options
                        .AddMqtt())

                // Delegate the inbound/outbound endpoints configuration to a separate
                // class.
                .AddEndpointsConfigurator&lt;EndpointsConfigurator&gt;();

            // Add API controllers and SwaggerGen
            services.AddControllers();
            services.AddSwaggerGen();
        }

        public void Configure(IApplicationBuilder app)
        {
            // Enable middlewares to serve generated Swagger JSON and UI
            app.UseSwagger().UseSwaggerUI(
                uiOptions =&gt;
                {
                    uiOptions.SwaggerEndpoint(
                        &quot;/swagger/v1/swagger.json&quot;,
                        $&quot;{GetType().Assembly.FullName} API&quot;);
                });

            // Enable routing and endpoints for controllers
            app.UseRouting();
            app.UseEndpoints(endpoints =&gt; { endpoints.MapControllers(); });
        }
    }
}
</code></pre></section>
<section id="tabpanel_CeZOj-G++Q_producer-endpoints" role="tabpanel" data-tab="producer-endpoints" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Producer.EndpointsConfigurator">using MQTTnet.Protocol;
using Silverback.Messaging.Configuration;
using Silverback.Messaging.Messages;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Producer
{
    public class EndpointsConfigurator : IEndpointsConfigurator
    {
        public void Configure(IEndpointsConfigurationBuilder builder)
        {
            builder
                .AddMqttEndpoints(
                    endpoints =&gt; endpoints

                        // Configure the client options
                        .Configure(
                            config =&gt; config
                                .WithClientId(&quot;samples.binary-file.producer&quot;)
                                .ConnectViaTcp(&quot;localhost&quot;))

                        // Produce the binary files to the
                        // samples-binary-file-streaming topic
                        .AddOutbound&lt;BinaryFileMessage&gt;(
                            endpoint =&gt; endpoint
                                .ProduceTo(&quot;samples/binary-files&quot;)
                                .WithQualityOfServiceLevel(
                                    MqttQualityOfServiceLevel.AtLeastOnce)));
        }
    }
}
</code></pre></section>
<section id="tabpanel_CeZOj-G++Q_producer-custom-message" role="tabpanel" data-tab="producer-custom-message" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Producer.CustomBinaryFileMessage">using Silverback.Messaging.Messages;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Producer.Messages
{
    public class CustomBinaryFileMessage : BinaryFileMessage
    {
        [Header(&quot;x-filename&quot;)]
        public string? Filename { get; set; }
    }
}
</code></pre></section>
<section id="tabpanel_CeZOj-G++Q_producer-controller" role="tabpanel" data-tab="producer-controller" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Producer.ProducerController">using System.IO;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Silverback.Messaging.Messages;
using Silverback.Messaging.Publishing;
using Silverback.Samples.Mqtt.BinaryFileStreaming.Producer.Messages;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Producer.Controllers
{
    [ApiController]
    [Route(&quot;[controller]&quot;)]
    public class ProducerController : ControllerBase
    {
        private readonly IPublisher _publisher;

        public ProducerController(IPublisher publisher)
        {
            _publisher = publisher;
        }

        [HttpPost(&quot;binary-file&quot;)]
        public async Task&lt;IActionResult&gt; ProduceBinaryFileAsync(
            string filePath,
            string? contentType)
        {
            // Open specified file stream
            using var fileStream = System.IO.File.OpenRead(filePath);

            // Create a BinaryFileMessage that wraps the file stream
            var binaryFileMessage = new BinaryFileMessage(fileStream);

            if (!string.IsNullOrEmpty(contentType))
                binaryFileMessage.ContentType = contentType;

            // Publish the BinaryFileMessage that will be routed to the outbound
            // endpoint. The FileStream will be read and produced chunk by chunk,
            // without the entire file being loaded into memory.
            await _publisher.PublishAsync(binaryFileMessage);

            return NoContent();
        }

        [HttpPost(&quot;custom-binary-file&quot;)]
        public async Task&lt;IActionResult&gt; ProduceBinaryFileWithCustomHeadersAsync(
            string filePath,
            string? contentType)
        {
            // Open specified file stream
            using var fileStream = System.IO.File.OpenRead(filePath);

            // Create a CustomBinaryFileMessage that wraps the file stream. The
            // CustomBinaryFileMessage extends the BinaryFileMessage adding an extra
            // Filename property that is also exported as header.
            var binaryFileMessage = new CustomBinaryFileMessage
            {
                Content = fileStream,
                Filename = Path.GetFileName(filePath)
            };

            if (!string.IsNullOrEmpty(contentType))
                binaryFileMessage.ContentType = contentType;

            // Publish the BinaryFileMessage that will be routed to the outbound
            // endpoint. The FileStream will be read and produced chunk by chunk,
            // without the entire file being loaded into memory.
            await _publisher.PublishAsync(binaryFileMessage);

            return NoContent();
        }
    }
}
</code></pre></section>
</div>

<p><em>Full source code: <a href="https://github.com/BEagle1984/silverback/tree/master/samples/Mqtt/BinaryFileStreaming.Producer">https://github.com/BEagle1984/silverback/tree/master/samples/Mqtt/BinaryFileStreaming.Producer</a></em></p>
<h2 id="consumer">Consumer</h2>
<p>The consumer simply streams the file to a temporary folder in the local file system.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_consumer-startup" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_consumer-startup" data-tab="consumer-startup" tabindex="0" aria-selected="true">Startup</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_consumer-endpoints" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_consumer-endpoints" data-tab="consumer-endpoints" tabindex="-1">EndpointsConfigurator</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_consumer-custom-message" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_consumer-custom-message" data-tab="consumer-custom-message" tabindex="-1">CustomBinaryFileMessage</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_consumer-subscriber" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_consumer-subscriber" data-tab="consumer-subscriber" tabindex="-1">Subscriber</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_consumer-startup" role="tabpanel" data-tab="consumer-startup">
<pre><code class="lang-csharp" name="Consumer.Startup">using Microsoft.Extensions.DependencyInjection;
using Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer.Subscribers;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer
{
    public class Startup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            // Enable Silverback
            services
                .AddSilverback()

                // Use Apache Mqtt as message broker
                .WithConnectionToMessageBroker(
                    options =&gt; options
                        .AddMqtt())

                // Delegate the inbound/outbound endpoints configuration to a separate
                // class.
                .AddEndpointsConfigurator&lt;EndpointsConfigurator&gt;()

                // Register the subscribers
                .AddSingletonSubscriber&lt;BinaryFileSubscriber&gt;();
        }

        public void Configure()
        {
        }
    }
}
</code></pre></section>
<section id="tabpanel_CeZOj-G++Q-1_consumer-endpoints" role="tabpanel" data-tab="consumer-endpoints" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Consumer.EndpointsConfigurator">using MQTTnet.Protocol;
using Silverback.Messaging.Configuration;
using Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer.Messages;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer
{
    public class EndpointsConfigurator : IEndpointsConfigurator
    {
        public void Configure(IEndpointsConfigurationBuilder builder)
        {
            builder
                .AddMqttEndpoints(
                    endpoints =&gt; endpoints

                        // Configure the client options
                        .Configure(
                            config =&gt; config
                                .WithClientId(&quot;samples.binary-file.consumer&quot;)
                                .ConnectViaTcp(&quot;localhost&quot;))

                        // Consume the samples-binary-file-streaming topic
                        .AddInbound(
                            endpoint =&gt; endpoint
                                .ConsumeFrom(&quot;samples/binary-files&quot;)
                                .WithQualityOfServiceLevel(
                                    MqttQualityOfServiceLevel.AtLeastOnce)

                                // Force the consumer to use the
                                // BinaryFileMessageSerializer: this is not strictly
                                // necessary when the messages are produced by
                                // Silverback but it increases the interoperability,
                                // since it doesn't have to rely on the
                                // 'x-message-type' header value to switch to the
                                // BinaryFileMessageSerializer.
                                //
                                // In this example the BinaryFileMessageSerializer is
                                // also set to return a CustomBinaryFileMessage
                                // instead of the normal BinaryFileMessage. This is
                                // only needed because we want to read the custom
                                // 'x-message-filename' header, otherwise
                                // 'ConsumeBinaryFiles()' would work perfectly fine
                                // (returning a basic BinaryFileMessage, without the
                                // extra properties).
                                .ConsumeBinaryFiles(
                                    serializer =&gt;
                                        serializer
                                            .UseModel&lt;CustomBinaryFileMessage&gt;())

                                // Retry each chunks sequence 5 times in case of an
                                // exception
                                .OnError(policy =&gt; policy.Retry(5))));
        }
    }
}
</code></pre></section>
<section id="tabpanel_CeZOj-G++Q-1_consumer-custom-message" role="tabpanel" data-tab="consumer-custom-message" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Consumer.CustomBinaryFileMessage">using Silverback.Messaging.Messages;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer.Messages
{
    public class CustomBinaryFileMessage : BinaryFileMessage
    {
        [Header(&quot;x-filename&quot;)]
        public string? Filename { get; set; }
    }
}
</code></pre></section>
<section id="tabpanel_CeZOj-G++Q-1_consumer-subscriber" role="tabpanel" data-tab="consumer-subscriber" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Consumer.BinaryFileSubscriber">using System;
using System.IO;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer.Messages;

namespace Silverback.Samples.Mqtt.BinaryFileStreaming.Consumer.Subscribers
{
    public class BinaryFileSubscriber
    {
        private const string OutputPath = &quot;../../temp&quot;;

        private readonly Random _random;

        private readonly ILogger&lt;BinaryFileSubscriber&gt; _logger;

        public BinaryFileSubscriber(ILogger&lt;BinaryFileSubscriber&gt; logger)
        {
            _random = new Random((int)DateTime.Now.Ticks);
            _logger = logger;
        }

        public async Task OnBinaryFileMessageReceivedAsync(
            CustomBinaryFileMessage binaryFileMessage)
        {
            EnsureTargetFolderExists();

            var filename = Guid.NewGuid().ToString(&quot;N&quot;) + binaryFileMessage.Filename;

            _logger.LogInformation($&quot;Saving binary file as {filename}...&quot;);

            // Create a FileStream to save the file
            using var fileStream = File.OpenWrite(Path.Combine(OutputPath, filename));

            if (binaryFileMessage.Content != null)
            {
                // Asynchronously copy the message content to the FileStream.
                // The message chunks are streamed directly and the entire file is
                // never loaded into memory.
                await binaryFileMessage.Content.CopyToAsync(fileStream);
            }

            // Randomly simulate a processing exception
            if (_random.Next(2) == 1)
                throw new InvalidOperationException(&quot;You must fail!&quot;);

            _logger.LogInformation(
                $&quot;Written {fileStream.Length} bytes into {filename}.&quot;);
        }

        private static void EnsureTargetFolderExists()
        {
            if (!Directory.Exists(OutputPath))
                Directory.CreateDirectory(OutputPath);
        }
    }
}
</code></pre></section>
</div>

<p><em>Full source code: <a href="https://github.com/BEagle1984/silverback/tree/master/samples/Mqtt/BinaryFileStreaming.Consumer">https://github.com/BEagle1984/silverback/tree/master/samples/Mqtt/BinaryFileStreaming.Consumer</a></em></p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/beagle1984/silverback/blob/master/docs/samples/mqtt/binaryfile-streaming.md/#L1" class="contribution-link">Improve this doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="footer">
          <div class="container contacts">
            <a href="https://github.com/BEagle1984" rel="nofollow noopener noreferrer"><i class='fab fa-github'></i> GitHub</a>
            <a href="mailto:silverback-project@outlook.com" rel="nofollow noopener noreferrer"><i class='fas fa-envelope'></i> E-Mail</a>
          </div>
          <div class="container">
            <span class="pull-right">
              <a href="#top">&uarr; Back to top</a>
            </span>
            © 2020 Sergio Aquilini
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
