// Copyright (c) 2024 Sergio Aquilini
// This code is licensed under MIT license (see LICENSE file for details)

using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Reflection;
using System.Text;
using Silverback.Tools.Generators.Common;

namespace Silverback.Tools.Generators.KafkaConfigProxies;

public class BuilderGenerator
{
    public BuilderGenerator(Type proxiedType)
        : this(proxiedType, $"Kafka{proxiedType.Name}urationBuilder")
    {
    }

    protected BuilderGenerator(Type proxiedType, string generatedClassName)
    {
        ProxiedType = proxiedType;
        GeneratedClassName = generatedClassName;
    }

    protected Type ProxiedType { get; }

    protected string GeneratedClassName { get; }

    protected StringBuilder StringBuilder { get; } = new();

    public virtual string Generate()
    {
        GenerateClassHeading();
        MapClassProperties();
        GenerateBasicFooter();

        return StringBuilder.ToString();
    }

    protected virtual string GetClassSummary() => $"The autogenerated part of the <see cref=\"{GeneratedClassName}\" /> class.";

    protected virtual string GetClassSignature() => $"public partial class {GeneratedClassName}";

    [SuppressMessage("Globalization", "CA1308:Normalize strings to uppercase", Justification = "False positive, it makes no sense")]
    protected virtual void MapClassProperties()
    {
        IEnumerable<PropertyInfo> properties =
            ReflectionHelper.GetProperties(ProxiedType, false)
                .Where(
                    property => !IgnoredProperties.Contains(property) &&
                                property.Name != "GroupId");

        foreach (PropertyInfo property in properties)
        {
            string propertyType = ReflectionHelper.GetTypeString(property.PropertyType, true);
            string valueVariableName = property.Name.ToCamelCase();
            string visibility = MustBeInternal(property.Name) ? "internal" : "public partial";

            StringBuilder.AppendLine($"    {visibility} {GeneratedClassName} With{property.Name}({propertyType} {valueVariableName})");
            StringBuilder.AppendLine("    {");
            StringBuilder.AppendLine($"        ClientConfig.{property.Name} = {valueVariableName};");
            StringBuilder.AppendLine("        return This;");
            StringBuilder.AppendLine("    }");
            StringBuilder.AppendLine();
        }
    }

    protected void GenerateBasicFooter() => StringBuilder.AppendLine("}");

    private static bool MustBeInternal(string propertyName) =>
        propertyName
            is "EnableAutoCommit"
            or "EnablePartitionEof"
            or "AllowAutoCreateTopics"
            or "EnableDeliveryReports"
            or "EnableIdempotence"
            or "TopicMetadataRefreshSparse"
            or "SocketKeepaliveEnable"
            or "SocketNagleDisable"
            or "ApiVersionRequest"
            or "EnableSslCertificateVerification"
            or "EnableSaslOauthbearerUnsecureJwt"
            or "CheckCrcs"
            or "EnableGaplessGuarantee"
            or "TransactionalId";

    private void GenerateClassHeading()
    {
        StringBuilder.AppendLine("/// <content>");
        StringBuilder.AppendLine($"///     {GetClassSummary()}");
        StringBuilder.AppendLine("/// </content>");
        StringBuilder.AppendLine("[SuppressMessage(\"StyleCop.CSharp.MaintainabilityRules\", \"SA1402:File may only contain a single type\", Justification = \"Autogenerated all at once\")]");
        StringBuilder.AppendLine("[SuppressMessage(\"StyleCop.CSharp.OrderingRules\", \"SA1202: 'public' members should come before 'internal' members\", Justification = \"Autogenerated\")]");
        StringBuilder.AppendLine("[SuppressMessage(\"StyleCop.CSharp.DocumentationRules\", \"SA1600:Elements should be documented\", Justification = \"Documented in other partial\")]");
        StringBuilder.AppendLine("[SuppressMessage(\"StyleCop.CSharp.DocumentationRules\", \"SA1601:Partial elements should be documented\", Justification = \"Autogenerated\")]");
        StringBuilder.AppendLine(GetClassSignature());
        StringBuilder.AppendLine("{");
    }
}
